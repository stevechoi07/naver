<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GridScan v1.5.1 (CSV ë‹¤ìš´ë¡œë“œ ë²„ê·¸ ìˆ˜ì •)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=Bdae71c83941e7abbe59827c2625be7b&libraries=services"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8f9fa; color: #212529; }
        .main-container { background-color: #ffffff; border: 1px solid #dee2e6; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .title-text { color: #14b8a6; }
        .search-button { background-color: #14b8a6; color: #ffffff; transition: all 0.2s ease-in-out; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .search-button:hover { background-color: #0d9488; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .search-button:disabled { background-color: #94a3b8; cursor: not-allowed; transform: none; box-shadow: none; }
        .cancel-button { background-color: #ef4444; color: #ffffff; transition: all 0.2s ease-in-out; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .cancel-button:hover { background-color: #dc2626; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .progress-bar { background-color: #e9ecef; border-radius: 9999px; overflow: hidden; }
        .progress-bar-fill { background-color: #14b8a6; transition: width 0.3s ease-in-out; }
        .result-table { width: 100%; border-collapse: collapse; }
        .result-table th, .result-table td { border: 1px solid #dee2e6; padding: 0.75rem; text-align: left; }
        .result-table thead { background-color: #f1f5f9; }
        .result-table tbody tr:nth-child(even) { background-color: #f8fafc; }
        .status-pass { color: #16a34a; font-weight: bold; }
        .status-fail { color: #ef4444; font-weight: bold; }
        .address-counter.over-limit { color: #ef4444; font-weight: bold; }
        .toast-notification {
            position: fixed; top: 20px; right: 20px; background-color: #212529; color: #ffffff; padding: 1rem 1.5rem;
            border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transform: translateX(120%);
            transition: transform 0.3s ease-in-out; z-index: 1000; opacity: 0;
        }
        .toast-notification.show { transform: translateX(0); opacity: 1; }
        .toast-notification.error { background-color: #dc2626; }
        
        /* v1.5: ê°œë°œì ë¡œê·¸ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .dev-log-container { background-color: #1e293b; color: #e2e8f0; font-family: 'Courier New', Courier, monospace; font-size: 0.875rem; max-height: 300px; overflow-y: auto; border-radius: 0.5rem; padding: 1rem; border: 1px solid #334155; }
        .log-line { padding: 0.1rem 0; border-bottom: 1px solid #334155; }
        .log-line.info { color: #93c5fd; }
        .log-line.success { color: #86efac; }
        .log-line.error { color: #fca5a5; }
        .log-line.warn { color: #fde047; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="main-container w-full max-w-5xl mx-auto rounded-2xl p-6 sm:p-8 space-y-8">
        
        <div class="text-center space-y-2">
            <h1 class="text-3xl sm:text-4xl font-bold title-text">âš¡ï¸ GridScan v1.5.1 âš¡ï¸</h1>
            <p class="text-gray-600 text-sm sm:text-base">ëŒ€ìš©ëŸ‰ ì£¼ì†Œ ë¶„ì„ ì—”ì§„ íƒ‘ì¬! ìµœëŒ€ 2,500ê°œê¹Œì§€ í•œ ë²ˆì— ë¶„ì„í•˜ì„¸ìš”.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <div class="flex justify-between items-center mb-2">
                    <label for="address-list" class="block text-lg font-semibold text-gray-700">ì£¼ì†Œ ëª©ë¡ ë¶™ì—¬ë„£ê¸°</label>
                    <span id="address-counter" class="text-sm font-medium text-gray-500">0 / 2500 ê°œ</span>
                </div>
                <textarea id="address-list" rows="10" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="ì˜ˆ:&#10;ê²½ê¸°ë„ ì„±ë‚¨ì‹œ ì¤‘ì›êµ¬ ë„ì´Œë‚¨ë¡œ 101&#10;ê²½ê¸°ë„ ê³ ì–‘ì‹œ ë•ì–‘êµ¬ í–¥ë™ë™ 407&#10;(í•œ ì¤„ì— ì£¼ì†Œ í•˜ë‚˜ì”© ì…ë ¥)"></textarea>
            </div>
            <div class="flex flex-col justify-between">
                <div>
                    <p class="text-lg font-semibold text-gray-700 mb-2">ë˜ëŠ” CSV íŒŒì¼ ì—…ë¡œë“œ</p>
                    <input type="file" id="csv-file-input" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100"/>
                    <p class="text-xs text-gray-500 mt-2">ì²« ë²ˆì§¸ ì—´ì— ì£¼ì†Œê°€ í¬í•¨ëœ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
                </div>
                <button id="start-analysis-btn" class="search-button w-full font-bold py-4 px-8 rounded-lg text-lg mt-4">ë¶„ì„ ì‹œì‘</button>
            </div>
        </div>

        <div id="progress-section" class="hidden pt-6 space-y-4">
            <div class="flex justify-between items-center font-semibold">
                <span id="progress-label" class="text-teal-600">ë¶„ì„ ì¤€ë¹„ ì¤‘...</span>
                <span id="progress-text" class="text-gray-700">0 / 0</span>
            </div>
            <div class="progress-bar h-4">
                <div id="progress-bar-fill" class="progress-bar-fill h-4" style="width: 0%;"></div>
            </div>
            <div class="text-center">
                <button id="cancel-analysis-btn" class="cancel-button font-bold py-2 px-6 rounded-lg text-base">ë¶„ì„ ì¤‘ë‹¨</button>
            </div>
            
            <!-- v1.5: ê°œë°œììš© ì‹¤ì‹œê°„ ë¡œê·¸ ì°½ ì¶”ê°€ -->
            <div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">ì‹¤ì‹œê°„ ì‘ì „ ìƒí™©ì‹¤ (ê°œë°œì ë¡œê·¸)</h3>
                <div id="dev-log-container" class="dev-log-container"></div>
            </div>
        </div>

        <div id="result-section" class="hidden pt-6">
            <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-4">
                <h2 class="text-2xl font-bold text-gray-800">ì¢…í•© ë¶„ì„ ê²°ê³¼</h2>
                <button id="download-csv-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-green-700 transition-colors w-full sm:w-auto">ê²°ê³¼ ë‹¤ìš´ë¡œë“œ (CSV)</button>
            </div>
            <div class="overflow-x-auto border rounded-lg">
                <table class="result-table text-sm">
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>ì£¼ì†Œ</th>
                            <th>ì§„ë‹¨ ê²°ê³¼</th>
                            <th>ìµœê·¼ì ‘ ì‹œì„¤</th>
                            <th>ê±°ë¦¬(m)</th>
                            <th>ìµœê³  ì „ì••(kV)</th>
                        </tr>
                    </thead>
                    <tbody id="result-table-body">
                    </tbody>
                </table>
            </div>
        </div>
        
    </div>
    
    <div id="toast" class="toast-notification"></div>

    <script type="module">
        // --- v1.5: ìƒìˆ˜ ê´€ë¦¬ ---
        const ADDRESS_LIMIT = 2500; // ìµœëŒ€ ë¶„ì„ ê°œìˆ˜ 2500ê°œë¡œ ìƒí–¥!
        const BATCH_SIZE = 50; // í•œ ë²ˆì— ì²˜ë¦¬í•  ê·¸ë£¹(Batch) í¬ê¸°
        const CONCURRENT_REQUESTS = 10; // í•œ ê·¸ë£¹ ë‚´ì—ì„œ ë™ì‹œì— ë³´ë‚¼ ìš”ì²­ ìˆ˜ (API ê³¼ë¶€í•˜ ë°©ì§€)
        const INTER_BATCH_DELAY_MS = 1000; // ê·¸ë£¹(Batch) ì²˜ë¦¬ ì‚¬ì´ì˜ ì§€ì—° ì‹œê°„ (API ì„œë²„ ë³´í˜¸)
        const OVERPASS_API_ENDPOINT = 'https://overpass-api.de/api/interpreter';
        const SEARCH_RADIUS_METERS = 1000;

        // --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
        const addressListInput = document.getElementById('address-list');
        const csvFileInput = document.getElementById('csv-file-input');
        const startAnalysisBtn = document.getElementById('start-analysis-btn');
        const progressSection = document.getElementById('progress-section');
        const progressLabel = document.getElementById('progress-label');
        const progressText = document.getElementById('progress-text');
        const progressBarFill = document.getElementById('progress-bar-fill');
        const resultSection = document.getElementById('result-section');
        const resultTableBody = document.getElementById('result-table-body');
        const downloadCsvBtn = document.getElementById('download-csv-btn');
        const addressCounter = document.getElementById('address-counter');
        const toast = document.getElementById('toast');
        const cancelAnalysisBtn = document.getElementById('cancel-analysis-btn');
        const devLogContainer = document.getElementById('dev-log-container'); // v1.5 ì¶”ê°€

        // --- ì „ì—­ ë³€ìˆ˜ ---
        let geocoderInstance = null;
        let analysisResults = [];
        let isAnalysisCancelled = false;

        // --- ì´ˆê¸°í™” ---
        kakao.maps.load(() => { geocoderInstance = new kakao.maps.services.Geocoder(); });
        
        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ---
        startAnalysisBtn.addEventListener('click', handleStartAnalysis);
        csvFileInput.addEventListener('change', handleFileUpload);
        downloadCsvBtn.addEventListener('click', downloadResultsAsCsv);
        addressListInput.addEventListener('input', updateAddressCounter);
        cancelAnalysisBtn.addEventListener('click', handleCancelAnalysis);

        // --- v1.5: ì‹¤ì‹œê°„ ë¡œê·¸ í•¨ìˆ˜ ---
        function addLog(message, type = 'info') {
            const now = new Date();
            const timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            const logLine = document.createElement('div');
            logLine.className = `log-line ${type}`;
            logLine.textContent = `[${timestamp}] ${message}`;
            devLogContainer.appendChild(logLine);
            // í•­ìƒ ìµœì‹  ë¡œê·¸ê°€ ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ì´ë™
            devLogContainer.scrollTop = devLogContainer.scrollHeight;
        }

        function showToast(message, type = 'info') {
            toast.textContent = message;
            toast.className = 'toast-notification';
            if (type === 'error') toast.classList.add('error');
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        function updateAddressCounter() {
            const addresses = addressListInput.value.split('\n').map(line => line.trim()).filter(line => line);
            const count = addresses.length;
            addressCounter.textContent = `${count} / ${ADDRESS_LIMIT} ê°œ`;
            addressCounter.classList.toggle('over-limit', count > ADDRESS_LIMIT);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').map(line => line.trim()).filter(line => line);
                const addresses = lines.map(line => line.split(',')[0].trim()).filter(Boolean); 
                addressListInput.value = addresses.join('\n');
                updateAddressCounter();
            };
            reader.readAsText(file, 'euc-kr'); // í•œê¸€ CSV íŒŒì¼ì„ ìœ„í•´ ì¸ì½”ë”© ì§€ì •
        }

        function handleCancelAnalysis() {
            isAnalysisCancelled = true;
            addLog('ğŸš¨ ë¶„ì„ ì¤‘ë‹¨ ëª…ë ¹ ìˆ˜ì‹ ! í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì‘ì—… ì™„ë£Œ í›„ ì¤‘ë‹¨ë©ë‹ˆë‹¤.', 'warn');
            showToast('ë¶„ì„ì„ ì¤‘ë‹¨í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
        }

        // --- v1.5: ëŒ€ìš©ëŸ‰ ì²˜ë¦¬ë¥¼ ìœ„í•œ ìƒˆë¡œìš´ ë¶„ì„ ì‹œì‘ í•¨ìˆ˜ ---
        async function handleStartAnalysis() {
            const addresses = addressListInput.value.split('\n').map(line => line.trim()).filter(line => line);
            if (addresses.length === 0) {
                showToast('ë¶„ì„í•  ì£¼ì†Œë¥¼ ì…ë ¥í•˜ê±°ë‚˜ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            if (addresses.length > ADDRESS_LIMIT) {
                showToast(`í•œ ë²ˆì— ìµœëŒ€ ${ADDRESS_LIMIT}ê°œê¹Œì§€ë§Œ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬ ${addresses.length}ê°œ)`, 'error');
                return;
            }

            // --- ë¶„ì„ ì‹œì‘ UI ì„¤ì • ---
            startAnalysisBtn.disabled = true;
            startAnalysisBtn.textContent = 'ë¶„ì„ ì¤‘...';
            resultSection.classList.add('hidden');
            progressSection.classList.remove('hidden');
            resultTableBody.innerHTML = '';
            devLogContainer.innerHTML = ''; // ë¡œê·¸ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
            analysisResults = [];
            isAnalysisCancelled = false;
            let processedCount = 0;
            const totalCount = addresses.length;

            addLog(`ì´ ${totalCount}ê°œì˜ ì£¼ì†Œì— ëŒ€í•œ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤. (ê·¸ë£¹ í¬ê¸°: ${BATCH_SIZE}ê°œ)`, 'info');

            // ì£¼ì†Œ ëª©ë¡ì„ BATCH_SIZEì— ë§ì¶° ì—¬ëŸ¬ ê·¸ë£¹(Batch)ìœ¼ë¡œ ë‚˜ëˆ•ë‹ˆë‹¤.
            for (let i = 0; i < totalCount; i += BATCH_SIZE) {
                if (isAnalysisCancelled) {
                    addLog('âœ‹ ë¶„ì„ ì¤‘ë‹¨ í”Œë˜ê·¸ í™•ì¸. ëª¨ë“  ì‘ì—…ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤.', 'warn');
                    break;
                }

                const batch = addresses.slice(i, i + BATCH_SIZE);
                const batchNumber = (i / BATCH_SIZE) + 1;
                addLog(`--- [ê·¸ë£¹ ${batchNumber}] ${batch.length}ê°œ ì£¼ì†Œ ì²˜ë¦¬ ì‹œì‘ ---`, 'info');
                
                // í•œ ê·¸ë£¹ ë‚´ì—ì„œë„ CONCURRENT_REQUESTS ë§Œí¼ ë‚˜ëˆ„ì–´ ë³‘ë ¬ ì²˜ë¦¬í•©ë‹ˆë‹¤. (API ì„œë²„ ë³´í˜¸ ê°•í™”)
                const chunkResults = [];
                for (let j = 0; j < batch.length; j += CONCURRENT_REQUESTS) {
                    if (isAnalysisCancelled) break;

                    const chunk = batch.slice(j, j + CONCURRENT_REQUESTS);
                    
                    // Promise.allSettledë¥¼ ì‚¬ìš©í•˜ì—¬ ì¼ë¶€ ìš”ì²­ì´ ì‹¤íŒ¨í•´ë„ ì „ì²´ê°€ ì¤‘ë‹¨ë˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.
                    const promises = chunk.map((address, index) => 
                        analyzeSingleAddress(address, i + j + index + 1)
                    );
                    const results = await Promise.allSettled(promises);
                    
                    results.forEach(result => {
                        if (result.status === 'fulfilled') {
                            chunkResults.push(result.value);
                        } else {
                            // ì´ ê²½ìš°ëŠ” analyzeSingleAddress ë‚´ë¶€ì˜ try-catchì—ì„œ ì²˜ë¦¬ë˜ë¯€ë¡œ ê±°ì˜ ë°œìƒí•˜ì§€ ì•ŠìŒ
                            addLog(`ì¹˜ëª…ì  ì˜¤ë¥˜ ë°œìƒ: ${result.reason}`, 'error');
                        }
                    });
                }
                
                // ì´ë²ˆ ê·¸ë£¹(Batch)ì—ì„œ ì²˜ë¦¬ëœ ê²°ê³¼ë“¤ì„ ì¢…í•© ê²°ê³¼ì— ì¶”ê°€
                analysisResults.push(...chunkResults);
                processedCount += batch.length;

                // UI ì—…ë°ì´íŠ¸
                progressLabel.textContent = `[ê·¸ë£¹ ${batchNumber} ì²˜ë¦¬ ì™„ë£Œ] ë‹¤ìŒ ê·¸ë£¹ ì¤€ë¹„ ì¤‘...`;
                progressText.textContent = `${processedCount} / ${totalCount}`;
                progressBarFill.style.width = `${(processedCount / totalCount) * 100}%`;
                
                // ë‹¤ìŒ ê·¸ë£¹ ì²˜ë¦¬ë¥¼ ì‹œì‘í•˜ê¸° ì „ ì ì‹œ ëŒ€ê¸°
                if (i + BATCH_SIZE < totalCount && !isAnalysisCancelled) {
                    await new Promise(resolve => setTimeout(resolve, INTER_BATCH_DELAY_MS));
                }
            }

            // --- ë¶„ì„ ì¢…ë£Œ UI ì„¤ì • ---
            if (isAnalysisCancelled) {
                progressLabel.textContent = 'ë¶„ì„ì´ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.';
                addLog('ë¶„ì„ ì‘ì—…ì´ ìµœì¢…ì ìœ¼ë¡œ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.', 'warn');
            } else {
                progressLabel.textContent = 'ë¶„ì„ ì™„ë£Œ!';
                addLog(`ï¿½ ì´ ${processedCount}ê°œì˜ ì£¼ì†Œ ë¶„ì„ ì™„ë£Œ!`, 'success');
            }
            startAnalysisBtn.disabled = false;
            startAnalysisBtn.textContent = 'ë¶„ì„ ì‹œì‘';
            
            // ê²°ê³¼ê°€ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ê²°ê³¼ ì„¹ì…˜ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
            if (analysisResults.length > 0) {
                resultSection.classList.remove('hidden');
            }
        }

        async function analyzeSingleAddress(address, totalIndex) {
            try {
                // 1. ì£¼ì†Œ -> ì¢Œí‘œ ë³€í™˜
                const coords = await getCoordsFromAddress(address);
                // 2. ì¢Œí‘œ ì£¼ë³€ ì‹œì„¤ë¬¼ íƒìƒ‰
                const facilities = await findFacilities(coords.lat, coords.lon);
                // 3. ìì²´ ê·œì¹™ì— ë”°ë¼ í•„í„°ë§
                const filtered = filterFacilities(facilities, coords.lat, coords.lon);

                let result;
                if (filtered.length > 0) {
                    const closest = filtered.sort((a, b) => a.distance - b.distance)[0];
                    const highestVoltage = filtered.reduce((max, el) => parseVoltage(el.tags.voltage) > parseVoltage(max.tags.voltage) ? el : max, filtered[0]);
                    const powerTypes = { substation: 'ë³€ì „ì†Œ', line: 'ì†¡ì „ì„ ', tower: 'ì†¡ì „íƒ‘', cable: 'ì¼€ì´ë¸”' };
                    
                    result = {
                        index: totalIndex, // v1.5.1 ìˆ˜ì •: ê²°ê³¼ ê°ì²´ì— ê³ ìœ  ë²ˆí˜¸(index) ì¶”ê°€
                        address, status: 'í•´ë‹¹',
                        closestFacility: closest.tags.name || powerTypes[closest.tags.power] || 'ì‹œì„¤',
                        distance: Math.round(closest.distance),
                        highestVoltage: parseVoltage(highestVoltage.tags.voltage) / 1000
                    };
                    addLog(`[${totalIndex}] ${address} -> í•´ë‹¹ (ìµœê·¼ì ‘: ${result.closestFacility}, ${result.distance}m)`, 'success');
                } else {
                    result = { 
                        index: totalIndex, // v1.5.1 ìˆ˜ì •: ê²°ê³¼ ê°ì²´ì— ê³ ìœ  ë²ˆí˜¸(index) ì¶”ê°€
                        address, status: 'í•´ë‹¹ ì—†ìŒ', closestFacility: '-', distance: '-', highestVoltage: '-' 
                    };
                    addLog(`[${totalIndex}] ${address} -> í•´ë‹¹ ì—†ìŒ`, 'info');
                }
                appendResultToTable(result, totalIndex);
                return result;

            } catch (error) {
                const result = { 
                    index: totalIndex, // v1.5.1 ìˆ˜ì •: ê²°ê³¼ ê°ì²´ì— ê³ ìœ  ë²ˆí˜¸(index) ì¶”ê°€
                    address, status: 'ë¶„ì„ ì‹¤íŒ¨', closestFacility: error.message, distance: '-', highestVoltage: '-' 
                };
                addLog(`[${totalIndex}] ${address} -> ì‹¤íŒ¨ (${error.message})`, 'error');
                appendResultToTable(result, totalIndex);
                return result;
            }
        }
        
        function getCoordsFromAddress(address) {
            return new Promise((resolve, reject) => {
                if (!geocoderInstance) {
                    reject(new Error('Geocoder ì´ˆê¸°í™” ì•ˆë¨'));
                    return;
                }
                geocoderInstance.addressSearch(address, (result, status) => {
                    if (status === kakao.maps.services.Status.OK) {
                        resolve({ lat: result[0].y, lon: result[0].x });
                    } else {
                        reject(new Error('ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨'));
                    }
                });
            });
        }

        async function findFacilities(lat, lon) {
            const query = `[out:json];(node["power"](around:${SEARCH_RADIUS_METERS},${lat},${lon});way["power"](around:${SEARCH_RADIUS_METERS},${lat},${lon});relation["power"](around:${SEARCH_RADIUS_METERS},${lat},${lon}););out center;`;
            const response = await fetch(OVERPASS_API_ENDPOINT, { method: 'POST', body: query });
            if (!response.ok) throw new Error(`API íƒìƒ‰ ì‹¤íŒ¨ (${response.status})`);
            const data = await response.json();
            return data.elements;
        }

        function filterFacilities(elements, centerLat, centerLon) {
            const distanceRules = {
                line: { '765000': 1000, '500000': 800, '345000': 700 },
                substation: { '765000': 850, '500000': 800, '345000': 600 }
            };
            const elementsWithDistance = elements.map(el => {
                const facilityCoords = el.center || el;
                const distance = haversineDistance(centerLat, centerLon, facilityCoords.lat, facilityCoords.lon);
                return { ...el, distance };
            });
            return elementsWithDistance.filter(el => {
                const powerTag = el.tags?.power;
                const voltage = parseVoltage(el.tags?.voltage);
                if (voltage === 0 || !powerTag) return false;
                let ruleType;
                if (['line', 'tower', 'cable'].includes(powerTag)) ruleType = 'line';
                else if (powerTag === 'substation') ruleType = 'substation';
                else return false;
                const ruleVoltage = String(voltage);
                if (!distanceRules[ruleType][ruleVoltage]) return false;
                const maxDistance = distanceRules[ruleType][ruleVoltage];
                return el.distance <= maxDistance;
            });
        }

        function appendResultToTable(result, index) {
            const row = document.createElement('tr');
            const statusClass = result.status === 'í•´ë‹¹' ? 'status-fail' : (result.status === 'í•´ë‹¹ ì—†ìŒ' ? 'status-pass' : '');
            row.innerHTML = `
                <td class="text-center">${index}</td>
                <td>${result.address}</td>
                <td class="${statusClass}">${result.status}</td>
                <td>${result.closestFacility}</td>
                <td class="text-right">${result.distance}</td>
                <td class="text-right">${result.highestVoltage}</td>
            `;
            resultTableBody.appendChild(row);
        }
        
        function downloadResultsAsCsv() {
            if (analysisResults.length === 0) {
                showToast('ë‹¤ìš´ë¡œë“œí•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM for Excel
            csvContent += "No.,ì£¼ì†Œ,ì§„ë‹¨ ê²°ê³¼,ìµœê·¼ì ‘ ì‹œì„¤,ê±°ë¦¬(m),ìµœê³  ì „ì••(kV)\n";
            
            // v1.5.1 ìˆ˜ì •: ì´ì œ ê° result ê°ì²´ì— indexê°€ ìˆìœ¼ë¯€ë¡œ ì •ë ¬ì´ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.
            analysisResults.sort((a, b) => a.index - b.index).forEach((result, index) => {
                const row = [
                    result.index, // No. ì—´ì— ì›ë˜ ìˆœë²ˆì„ ì‚¬ìš©
                    `"${result.address.replace(/"/g, '""')}"`,
                    result.status,
                    `"${result.closestFacility.toString().replace(/"/g, '""')}"`,
                    result.distance,
                    result.highestVoltage
                ].join(',');
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `GridScan_results_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; const Ï†1 = lat1 * Math.PI/180; const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180; const Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function parseVoltage(voltageTag) {
            if (!voltageTag) return 0;
            if (typeof voltageTag === 'string') {
                const voltages = voltageTag.split(';').map(v => parseInt(v.replace(/\D/g, ''))).filter(v => !isNaN(v));
                return voltages.length > 0 ? Math.max(...voltages) : 0;
            }
            if (typeof voltageTag === 'number') return voltageTag;
            return 0;
        }
    </script>
</body>
</html>