<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„¤ì´ë²„ ìˆœìœ„ íƒì • v3.4</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        /* ----------------------------------------------------------------------------- */
        /* ğŸ•µï¸â€â™‚ï¸ ë„¤ì´ë²„ ìˆœìœ„ íƒì • v3.4 - style.css                                       */
        /* ----------------------------------------------------------------------------- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+KR:wght@400;500;700&display=swap');
        
        :root {
            --primary-color: #00C753;
            --primary-hover-color: #00B34A;
            --background-color: #f7f9fc;
            --card-background: #ffffff;
            --text-color: #2c3e50;
            --subtext-color: #8fa1b2;
            --border-color: #e9ecef;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            --shadow: 0 6px 20px rgba(0, 0, 0, 0.07);
            --font-main: 'Inter', 'Noto Sans KR', sans-serif;
        }
        
        html { font-size: 15px; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: var(--font-main);
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.7;
            -webkit-font-smoothing: antialiased;
        }

        .main-container {
            max-width: 1280px;
            margin: 40px auto;
            padding: 0 20px;
            position: relative;
        }

        .home-button {
            position: absolute;
            top: 10px;
            left: 20px;
            text-decoration: none;
            background-color: var(--card-background);
            color: var(--text-color);
            padding: 8px 16px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            border: 1px solid var(--border-color);
        }
        .home-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }

        .main-layout { display: flex; gap: 30px; }
        .control-panel { flex: 1; position: sticky; top: 40px; align-self: flex-start; }
        .content-area { flex: 2.5; min-width: 0; }
        
        h1 {
            text-align: center;
            color: var(--text-color);
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 40px;
            letter-spacing: -1px;
            padding-top: 40px;
        }
        h1 span { color: var(--primary-color); }
        
        .card {
            background-color: var(--card-background);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }
        .card h2 {
            font-size: 1.6rem;
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }
        .card p {
            color: var(--subtext-color);
            margin-bottom: 25px;
            font-size: 0.95rem;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .card-divider {
            border: none;
            height: 1px;
            background-color: var(--border-color);
            margin: 25px 0;
        }
        
        label { font-weight: 500; margin-bottom: 8px; display: block; font-size: 0.9rem; color: #555; }
        
        input[type="text"], input[type="password"], textarea, select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 16px;
            background-color: #fdfdfd;
            transition: all 0.2s ease;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(0, 199, 83, 0.1);
            background-color: white;
        }
        textarea { resize: vertical; }
        
        button {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
            background-color: var(--primary-color);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 199, 83, 0.2);
        }
        button:hover {
            background-color: var(--primary-hover-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 199, 83, 0.3);
        }

        #rank-check-btn {
            width: 100%;
            font-size: 1.3rem;
            padding: 18px;
        }
        
        .button-group { display: flex; gap: 10px; }
        .button-group button { background-color: var(--subtext-color); box-shadow: none; font-size: 0.9rem; }
        .button-group button:hover { background-color: #777; }
        .button-group button.primary { background-color: var(--info-color); box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2); }
        .button-group button.primary:hover { background-color: #2980b9; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(52, 152, 219, 0.3); }

        #download-csv-btn {
            background-color: #fff;
            color: var(--text-color);
            font-size: 0.9rem;
            font-weight: 500;
            padding: 8px 16px;
            box-shadow: none;
            border: 1px solid var(--border-color);
            width: auto;
            white-space: nowrap;
            display: none; /* Initially hidden */
        }
        #download-csv-btn:hover {
            background-color: #f8f9fa;
            border-color: #d3d3d3;
        }

        .loader-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9); justify-content: center; align-items: center; flex-direction: column; z-index: 1001; backdrop-filter: blur(5px); }
        .loader-content { text-align: center; }
        .loader-spinner { border: 6px solid #e0e0e0; border-top: 6px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 25px auto; }
        .loader-content p { margin-bottom: 15px; font-size: 1.3rem; font-weight: 500; }
        .progress-bar-container { width: 300px; height: 12px; background-color: #e0e0e0; border-radius: 6px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background-color: var(--primary-color); transition: width 0.3s ease; }
        .progress-text { margin-top: 10px; font-size: 1rem; color: var(--subtext-color); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 40px; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-content h2 { margin-top: 0; }
        .modal-content .button-group { margin-top: 20px; justify-content: flex-end; }
        
        .dashboard-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .filter-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .filter-controls select {
            max-width: 250px;
            margin-bottom: 0;
        }

        .view-mode-toggle { display: flex; background-color: #f0f0f0; border-radius: 8px; padding: 4px; }
        .view-mode-btn {
            background-color: transparent;
            color: var(--subtext-color);
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            box-shadow: none;
            width: auto;
        }
        .view-mode-btn.active {
            background-color: white;
            color: var(--text-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        @media (max-width: 992px) {
            .main-layout { flex-direction: column; }
            .control-panel { position: static; }
            .home-button { top: 15px; left: 15px; }
            h1 { padding-top: 60px; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <a href="index.html" class="home-button">ğŸ  í™ˆìœ¼ë¡œ</a>
        <h1>ğŸ•µï¸â€â™‚ï¸ ìˆœìœ„ ì¶”ì ê¸° <span>v3.4</span></h1>
        <div class="main-layout">
            <aside class="control-panel">
                <div class="card">
                    <h2>ğŸ“ í”„ë¡œì íŠ¸</h2>
                    <p>ì¶”ì í•  í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                    <select id="project-selector"></select>
                    <div class="button-group" style="margin-top:10px;">
                        <button id="new-project-btn" class="primary">â• New</button>
                        <button id="edit-project-btn">âœï¸ Edit</button>
                        <button id="delete-project-btn" style="background-color: var(--danger-color);">ğŸ—‘ï¸ Delete</button>
                    </div>
                </div>

                <div class="card">
                    <button id="rank-check-btn">ğŸš€ START</button>
                    <hr class="card-divider">
                    <h2 style="margin-bottom: 25px;">ğŸ“ í”„ë¡œì íŠ¸ ì •ë³´</h2>
                    
                    <label for="my-product-name">ë‚´ ìƒí’ˆ</label>
                    <input type="text" id="my-product-name" placeholder="ìƒí’ˆëª…">
                    <label for="store-name">ë‚´ ìŠ¤í† ì–´</label>
                    <input type="text" id="store-name" placeholder="ìŠ¤í† ì–´ëª…">
                    <label for="competitors">ê²½ìŸì‚¬ (ìƒí’ˆëª… :: ìŠ¤í† ì–´ëª…)</label>
                    <textarea id="competitors" rows="3" placeholder="ê²½ìŸì‚¬ ìƒí’ˆ 1 :: ìŠ¤í† ì–´ 1
ê²½ìŸì‚¬ ìƒí’ˆ 2"></textarea>
                    <label for="rank-keywords">í‚¤ì›Œë“œ (í•œ ì¤„ì— í•˜ë‚˜ì”©)</label>
                    <textarea id="rank-keywords" rows="5" placeholder="í‚¤ì›Œë“œ 1
í‚¤ì›Œë“œ 2"></textarea>
                     <p style="font-size: 0.8rem; text-align: right; margin-bottom: 0;">
                        <a href="#" id="save-changes-link">ë³€ê²½ì‚¬í•­ ì €ì¥</a>
                    </p>
                </div>
                
                <div class="card">
                    <h2>ğŸ”‘ API í‚¤</h2>
                    <p>API í‚¤ëŠ” í˜„ì¬ ë¸Œë¼ìš°ì €ì—ë§Œ ì•ˆì „í•˜ê²Œ ì €ì¥ë©ë‹ˆë‹¤.</p>
                    <input type="password" id="naver-client-id" placeholder="ë„¤ì´ë²„ Client ID">
                    <input type="password" id="naver-client-secret" placeholder="ë„¤ì´ë²„ Client Secret">
                    <button id="save-api-key-btn">API í‚¤ ì €ì¥</button>
                </div>
            </aside>

            <main class="content-area">
                <div class="card">
                    <h2>ğŸ“ˆ ìˆœìœ„ ëŒ€ì‹œë³´ë“œ</h2>
                    <div class="dashboard-controls">
                        <div id="view-mode-toggle" class="view-mode-toggle">
                            <button class="view-mode-btn active" data-mode="daily">ì¼ë³„ ë³´ê¸°</button>
                            <button class="view-mode-btn" data-mode="hourly">ì‹œê°„ë³„ ë³´ê¸°</button>
                        </div>
                        <div class="filter-controls">
                            <select id="keyword-chart-filter"></select>
                            <button id="download-csv-btn">ì—‘ì…€(CSV) ë‹¤ìš´ë¡œë“œ</button>
                        </div>
                    </div>
                    <p id="dashboard-subtitle">í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ë©´ ìˆœìœ„ ì°¨íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                    <canvas id="rank-chart"></canvas>
                </div>

                <div id="results-container" class="card">
                    <h2>ğŸ“Š ê²°ê³¼ ë³´ê³ ì„œ</h2>
                    <div id="result-content">
                        <p>ìˆœìœ„ ì¶”ì  ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="loader" class="loader-container">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <p>íƒì •ë‹˜ì´ ìˆ˜ì‚¬ ì¤‘ì…ë‹ˆë‹¤...</p>
            <div class="progress-bar-container">
                <div id="progress-bar" class="progress-bar"></div>
            </div>
            <p id="progress-text" class="progress-text">ì´ˆê¸°í™” ì¤‘...</p>
        </div>
    </div>

    <div id="project-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title">ìƒˆ í”„ë¡œì íŠ¸ ë§Œë“¤ê¸°</h2>
            <input type="text" id="modal-project-name" placeholder="í”„ë¡œì íŠ¸ ì´ë¦„ (ì˜ˆ: ì—¬ë¦„ ì‹ ìƒí’ˆ)">
            <label for="modal-my-product-name">ë‚´ ìƒí’ˆ</label>
            <input type="text" id="modal-my-product-name" placeholder="ìƒí’ˆëª…">
            <label for="modal-store-name">ë‚´ ìŠ¤í† ì–´</label>
            <input type="text" id="modal-store-name" placeholder="ìŠ¤í† ì–´ëª…">
            <label for="modal-competitors">ê²½ìŸì‚¬ (ìƒí’ˆëª… :: ìŠ¤í† ì–´ëª…)</label>
            <textarea id="modal-competitors" rows="3" placeholder="ê²½ìŸì‚¬ 1 :: ìŠ¤í† ì–´ 1"></textarea>
            <label for="modal-keywords">í‚¤ì›Œë“œ (í•œ ì¤„ì— í•˜ë‚˜ì”©)</label>
            <textarea id="modal-keywords" rows="5"></textarea>
            <div class="button-group">
                <button id="modal-cancel-btn">ì·¨ì†Œ</button>
                <button id="modal-save-btn" class="primary">ì €ì¥</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const MAX_REQUESTS = 50; 

            let projects = [];
            let currentProjectId = null;
            let rankChart;
            let currentViewMode = 'daily'; // 'daily' or 'hourly'

            const loader = document.getElementById('loader');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');

            const rankChartEl = document.getElementById('rank-chart').getContext('2d');
            const resultContent = document.getElementById('result-content');
            
            const saveApiKeyBtn = document.getElementById('save-api-key-btn');
            const clientIdEl = document.getElementById('naver-client-id');
            const clientSecretEl = document.getElementById('naver-client-secret');

            const projectSelector = document.getElementById('project-selector');
            const newProjectBtn = document.getElementById('new-project-btn');
            const editProjectBtn = document.getElementById('edit-project-btn');
            const deleteProjectBtn = document.getElementById('delete-project-btn');
            const saveChangesLink = document.getElementById('save-changes-link');
            
            const productNameEl = document.getElementById('my-product-name');
            const storeNameEl = document.getElementById('store-name');
            const competitorsEl = document.getElementById('competitors');
            const rankKeywordsEl = document.getElementById('rank-keywords');

            const projectModal = document.getElementById('project-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalProjectName = document.getElementById('modal-project-name');
            const modalProductName = document.getElementById('modal-my-product-name');
            const modalStoreName = document.getElementById('modal-store-name');
            const modalCompetitors = document.getElementById('modal-competitors');
            const modalKeywords = document.getElementById('modal-keywords');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalSaveBtn = document.getElementById('modal-save-btn');

            const rankCheckBtn = document.getElementById('rank-check-btn');
            
            const keywordChartFilter = document.getElementById('keyword-chart-filter');
            const dashboardSubtitle = document.getElementById('dashboard-subtitle');
            const downloadCsvBtn = document.getElementById('download-csv-btn');
            const viewModeToggle = document.getElementById('view-mode-toggle');

            const getProjects = () => JSON.parse(localStorage.getItem('projects_v7')) || [];
            const saveProjects = (projs) => localStorage.setItem('projects_v7', JSON.stringify(projs));
            
            function initializeApp() {
                loadApiKeys();
                projects = getProjects();
                currentProjectId = localStorage.getItem('currentProjectId');
                renderProjectSelector();
                displayCurrentProjectInfo();
                updateDashboard();
            }

            function parseTextToCompetitors(text) {
                return text.split('\n').map(line => {
                    const parts = line.split('::').map(p => p.trim());
                    if (!parts[0]) return null;
                    return { product: parts[0], store: parts[1] || '' };
                }).filter(Boolean);
            }

            function formatCompetitorsToText(competitors) {
                if (!competitors) return '';
                return competitors.map(c => c.store ? `${c.product} :: ${c.store}` : c.product).join('\n');
            }

            function renderProjectSelector() {
                projectSelector.innerHTML = '';
                if (projects.length === 0) {
                    projectSelector.innerHTML = '<option>ìƒˆ í”„ë¡œì íŠ¸ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”</option>';
                    return;
                }
                projects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    projectSelector.appendChild(option);
                });
                
                if (currentProjectId && projects.some(p => p.id === currentProjectId)) {
                    projectSelector.value = currentProjectId;
                } else if (projects.length > 0) {
                    currentProjectId = projects[0].id;
                    projectSelector.value = currentProjectId;
                    localStorage.setItem('currentProjectId', currentProjectId);
                }
            }

            function displayCurrentProjectInfo() {
                if (!currentProjectId || projects.length === 0) {
                    productNameEl.value = ''; storeNameEl.value = ''; competitorsEl.value = ''; rankKeywordsEl.value = '';
                    return;
                }
                const project = projects.find(p => p.id === currentProjectId);
                if (project) {
                    productNameEl.value = project.productName || '';
                    storeNameEl.value = project.storeName || '';
                    competitorsEl.value = formatCompetitorsToText(project.competitors);
                    rankKeywordsEl.value = (project.keywords || []).join('\n');
                }
            }
            
            function handleProjectSelection() {
                currentProjectId = projectSelector.value;
                localStorage.setItem('currentProjectId', currentProjectId);
                displayCurrentProjectInfo();
                updateDashboard();
                resultContent.innerHTML = '<p>í”„ë¡œì íŠ¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆœìœ„ ì¶”ì ì„ ì‹œì‘í•˜ì„¸ìš”.</p>';
            }

            function saveCurrentProjectInfo() {
                 if (!currentProjectId) return;
                const projectIndex = projects.findIndex(p => p.id === currentProjectId);
                if (projectIndex > -1) {
                    projects[projectIndex].productName = productNameEl.value.trim();
                    projects[projectIndex].storeName = storeNameEl.value.trim();
                    projects[projectIndex].competitors = parseTextToCompetitors(competitorsEl.value);
                    projects[projectIndex].keywords = rankKeywordsEl.value.split('\n').map(k => k.trim()).filter(Boolean);
                    saveProjects(projects);
                    alert('í”„ë¡œì íŠ¸ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            }
            
            function handleDeleteProject() {
                if (!currentProjectId || projects.length === 0) return alert('ì‚­ì œí•  í”„ë¡œì íŠ¸ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                if (confirm(`'${projects.find(p=>p.id===currentProjectId).name}' í”„ë¡œì íŠ¸ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.`)) {
                    projects = projects.filter(p => p.id !== currentProjectId);
                    currentProjectId = projects.length > 0 ? projects[0].id : null;
                    localStorage.setItem('currentProjectId', currentProjectId);
                    saveProjects(projects);
                    renderProjectSelector();
                    displayCurrentProjectInfo();
                    updateDashboard();
                }
            }

            let editingProjectId = null;
            function openModal(mode = 'new') {
                projectModal.style.display = 'flex';
                if (mode === 'edit' && currentProjectId) {
                    const project = projects.find(p => p.id === currentProjectId);
                    if (!project) return;
                    modalTitle.textContent = 'í”„ë¡œì íŠ¸ ìˆ˜ì •';
                    editingProjectId = project.id;
                    modalProjectName.value = project.name;
                    modalProductName.value = project.productName || '';
                    modalStoreName.value = project.storeName || '';
                    modalCompetitors.value = formatCompetitorsToText(project.competitors);
                    modalKeywords.value = (project.keywords || []).join('\n');
                } else {
                    modalTitle.textContent = 'ìƒˆ í”„ë¡œì íŠ¸ ë§Œë“¤ê¸°';
                    editingProjectId = null;
                    modalProjectName.value = '';
                    modalProductName.value = '';
                    modalStoreName.value = '';
                    modalCompetitors.value = '';
                    modalKeywords.value = '';
                }
            }

            function closeModal() {
                projectModal.style.display = 'none';
            }

            function handleSaveProject() {
                const name = modalProjectName.value.trim();
                const productName = modalProductName.value.trim();
                if (!name || !productName) return alert('í”„ë¡œì íŠ¸ ì´ë¦„ê³¼ ë‚´ ìƒí’ˆëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');

                const projectData = {
                    name,
                    productName,
                    storeName: modalStoreName.value.trim(),
                    competitors: parseTextToCompetitors(modalCompetitors.value),
                    keywords: modalKeywords.value.split('\n').map(k => k.trim()).filter(Boolean),
                };

                if (editingProjectId) {
                    const projectIndex = projects.findIndex(p => p.id === editingProjectId);
                    if (projectIndex > -1) {
                        projects[projectIndex] = { ...projects[projectIndex], ...projectData };
                    }
                } else {
                    const newProject = {
                        id: `proj_${Date.now()}`,
                        ...projectData,
                        rankData: []
                    };
                    projects.push(newProject);
                    currentProjectId = newProject.id;
                    localStorage.setItem('currentProjectId', currentProjectId);
                }
                saveProjects(projects);
                renderProjectSelector();
                displayCurrentProjectInfo();
                updateDashboard();
                closeModal();
            }

            function saveApiKeys() {
                if(clientIdEl.value && clientSecretEl.value) {
                    localStorage.setItem('naverClientId', clientIdEl.value);
                    localStorage.setItem('naverClientSecret', clientSecretEl.value);
                    alert('API í‚¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    alert('Client IDì™€ Client Secretì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
            }

            function loadApiKeys() {
                clientIdEl.value = localStorage.getItem('naverClientId') || '';
                clientSecretEl.value = localStorage.getItem('naverClientSecret') || '';
            }

            function updateLoaderProgress(completed, total) {
                const percentage = total > 0 ? (completed / total) * 100 : 0;
                progressBar.style.width = `${percentage}%`;
                progressText.textContent = `ì²˜ë¦¬ ì¤‘... (${completed}/${total})`;
            }

            async function handleRankCheck() {
                if (!currentProjectId) return alert('ë¨¼ì € í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ìƒì„±í•´ì£¼ì„¸ìš”.');
                
                const project = projects.find(p => p.id === currentProjectId);
                if (!project || !project.productName) return alert('ë‚´ ìƒí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                if (!project.keywords || project.keywords.length === 0) return alert('ì¶”ì í•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');

                const userClientId = localStorage.getItem('naverClientId');
                const userClientSecret = localStorage.getItem('naverClientSecret');
                if (!userClientId || !userClientSecret) return alert('API í‚¤ë¥¼ ë¨¼ì € ì„¤ì •í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.');

                const productsToCheck = [
                    { product: project.productName, store: project.storeName }, 
                    ...(project.competitors || [])
                ];
                
                const totalTasks = productsToCheck.length * project.keywords.length;

                if (totalTasks > MAX_REQUESTS) {
                    return alert(`ìš”ì²­ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤! í•œ ë²ˆì— ìµœëŒ€ ${MAX_REQUESTS}ê°œê¹Œì§€ë§Œ ì¡°íšŒê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. (í˜„ì¬ ìš”ì²­: ${totalTasks}ê°œ) í‚¤ì›Œë“œë‚˜ ê²½ìŸì‚¬ ìˆ˜ë¥¼ ì¤„ì—¬ì£¼ì„¸ìš”.`);
                }
                
                let completedTasks = 0;
                loader.style.display = 'flex';
                updateLoaderProgress(completedTasks, totalTasks);
                resultContent.innerHTML = '<ul></ul>';
                
                for (const keyword of project.keywords) {
                    resultContent.querySelector('ul').innerHTML += `<li><strong>--- í‚¤ì›Œë“œ ì¶”ì  ì¤‘: '${keyword}' ---</strong></li>`;
                    for (const item of productsToCheck) {
                        const rank = await fetchRankFromNetlify(keyword, item.product, item.store, userClientId, userClientSecret);
                        
                        completedTasks++;
                        updateLoaderProgress(completedTasks, totalTasks);
                        
                        const timestamp = new Date().toISOString();
                        const rankText = rank > 0 ? `${rank}ìœ„` : '1000ìœ„ ë°–';
                        
                        const li = document.createElement('li');
                        const storeText = item.store ? ` (${item.store})` : '';
                        li.textContent = `[${item.product}${storeText}] ${rankText}`;
                        resultContent.querySelector('ul').appendChild(li);

                        if (rank > 0) {
                             project.rankData.push({ timestamp, keyword, rank, product: item.product, store: item.store || '' });
                        }
                    }
                }
                saveProjects(projects);
                loader.style.display = 'none';
                updateDashboard();
            }
            
            async function fetchRankFromNetlify(keyword, productName, storeName, clientId, clientSecret) {
                try {
                    const params = new URLSearchParams({ keyword, product: productName, store: storeName, clientId, clientSecret });
                    const response = await fetch(`/.netlify/functions/get-rank?${params.toString()}`);
                    if (!response.ok) throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                    const data = await response.json();
                    return data.rank;
                } catch (error) {
                    console.error("API ì˜¤ë¥˜:", error);
                     resultContent.querySelector('ul').innerHTML += `<li style="color: red;">ğŸš¨ '${productName}' ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ!</li>`;
                    return -1;
                }
            }

            function handleDownloadCsv() {
                if (!currentProjectId) return alert('ë¨¼ì € ë‹¤ìš´ë¡œë“œí•  í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                const project = projects.find(p => p.id === currentProjectId);
                if (!project || !project.rankData || project.rankData.length === 0) {
                    return alert('ë‹¤ìš´ë¡œë“œí•  ìˆœìœ„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }

                let csvContent = "\uFEFF"; 
                csvContent += "íƒ€ì„ìŠ¤íƒ¬í”„,í‚¤ì›Œë“œ,ìƒí’ˆëª…,ìŠ¤í† ì–´ëª…,ìˆœìœ„\n";

                project.rankData.forEach(d => {
                    const row = [
                        d.timestamp,
                        d.keyword,
                        `"${(d.product || '').replace(/"/g, '""')}"`,
                        `"${(d.store || '').replace(/"/g, '""')}"`,
                        d.rank
                    ].join(',');
                    csvContent += row + "\n";
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `${project.name}_ìˆœìœ„_ë°ì´í„°.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function updateDashboard() {
                if (!currentProjectId) {
                    dashboardSubtitle.textContent = 'í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ë©´ ìˆœìœ„ ì°¨íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.';
                    if (rankChart) rankChart.destroy();
                    keywordChartFilter.innerHTML = '';
                    downloadCsvBtn.style.display = 'none';
                    return;
                }
                const project = projects.find(p => p.id === currentProjectId);
                dashboardSubtitle.textContent = `'${project.name}' í”„ë¡œì íŠ¸ ëŒ€ì‹œë³´ë“œ`;

                if (project && project.rankData && project.rankData.length > 0) {
                    downloadCsvBtn.style.display = 'inline-flex';
                } else {
                    downloadCsvBtn.style.display = 'none';
                }

                const uniqueKeywords = [...new Set((project.rankData || []).map(d => d.keyword))];
                
                const currentFilterValue = keywordChartFilter.value;
                keywordChartFilter.innerHTML = '<option value="">-- ì°¨íŠ¸ë¥¼ ë³¼ í‚¤ì›Œë“œ ì„ íƒ --</option>';
                uniqueKeywords.forEach(k => {
                    const option = document.createElement('option');
                    option.value = k;
                    option.textContent = k;
                    keywordChartFilter.appendChild(option);
                });
                
                if (uniqueKeywords.includes(currentFilterValue)) {
                    keywordChartFilter.value = currentFilterValue;
                }
                
                drawChartForKeyword(keywordChartFilter.value);
            }
            
            function drawChartForKeyword(selectedKeyword) {
                const project = projects.find(p => p.id === currentProjectId);
                if (rankChart) { rankChart.destroy(); rankChart = null; }

                if (!project || !selectedKeyword) return;
                
                const chartData = processDataForChart(project.rankData, selectedKeyword, currentViewMode);
                
                rankChart = new Chart(rankChartEl, {
                    type: 'line', 
                    data: chartData,
                    options: {
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: currentViewMode === 'daily' ? 'day' : 'hour',
                                    tooltipFormat: 'yyyy-MM-dd HH:mm',
                                    displayFormats: {
                                        day: 'yyyy-MM-dd',
                                        hour: 'MM-dd HH:mm'
                                    }
                                }
                            },
                            y: { 
                                reverse: true, 
                                beginAtZero: false 
                            } 
                        } 
                    }
                });
            }

            function processDataForChart(data, selectedKeyword, mode) {
                if (!data || data.length === 0) return { labels: [], datasets: [] };
                
                const project = projects.find(p => p.id === currentProjectId);
                let filteredData = data.filter(d => d.keyword === selectedKeyword);

                if (mode === 'daily') {
                    const dailyLast = {};
                    filteredData.forEach(d => {
                        const date = d.timestamp.split('T')[0];
                        const key = `${date}|${d.product}|${d.store}`;
                        if (!dailyLast[key] || new Date(d.timestamp) > new Date(dailyLast[key].timestamp)) {
                            dailyLast[key] = d;
                        }
                    });
                    filteredData = Object.values(dailyLast);
                }

                const dataWithCombinedNames = filteredData.map(d => ({...d, productNameWithStore: d.store ? `${d.product} (${d.store})` : d.product }));
                const myProductNameWithStore = project.storeName ? `${project.productName} (${project.storeName})` : project.productName;
                
                const products = [...new Set(dataWithCombinedNames.map(item => item.productNameWithStore))];
                
                const datasets = products.map((productName, index) => {
                    const productData = dataWithCombinedNames
                        .filter(d => d.productNameWithStore === productName)
                        .map(d => ({ x: d.timestamp, y: d.rank }));
                    
                    const isMyProduct = productName === myProductNameWithStore;
                    const color = isMyProduct ? 'hsl(210, 80%, 55%)' : `hsl(${ (index * 60) % 360 }, 60%, 65%)`;

                    return { 
                        label: productName, 
                        data: productData, 
                        borderColor: color, 
                        backgroundColor: color, 
                        fill: false, 
                        tension: 0.1,
                        borderWidth: isMyProduct ? 4 : 2,
                        pointRadius: isMyProduct ? 5 : 3,
                    };
                });
                return { datasets };
            }

            // --- Event Listeners ---
            saveApiKeyBtn.addEventListener('click', saveApiKeys);
            newProjectBtn.addEventListener('click', () => openModal('new'));
            editProjectBtn.addEventListener('click', () => openModal('edit'));
            deleteProjectBtn.addEventListener('click', handleDeleteProject);
            projectSelector.addEventListener('change', handleProjectSelection);
            saveChangesLink.addEventListener('click', (e) => {
                e.preventDefault();
                saveCurrentProjectInfo();
            });
            modalCancelBtn.addEventListener('click', closeModal);
            modalSaveBtn.addEventListener('click', handleSaveProject);
            rankCheckBtn.addEventListener('click', handleRankCheck);
            keywordChartFilter.addEventListener('change', (e) => drawChartForKeyword(e.target.value));
            downloadCsvBtn.addEventListener('click', handleDownloadCsv);
            viewModeToggle.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    currentViewMode = e.target.dataset.mode;
                    viewModeToggle.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    drawChartForKeyword(keywordChartFilter.value);
                }
            });

            initializeApp();
        });
    </script>
</body>
</html>