<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>네이버 순위 탐정 v2.2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ----------------------------------------------------------------------------- */
        /* 🕵️‍♂️ 네이버 순위 탐정 v2.2 - style.css                                       */
        /* ----------------------------------------------------------------------------- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+KR:wght@400;500;700&display=swap');
        
        :root {
            --primary-color: #00C753;
            --primary-hover-color: #00B34A;
            --background-color: #f7f9fc;
            --card-background: #ffffff;
            --text-color: #2c3e50;
            --subtext-color: #8fa1b2;
            --border-color: #e9ecef;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            --shadow: 0 6px 20px rgba(0, 0, 0, 0.07);
            --font-main: 'Inter', 'Noto Sans KR', sans-serif;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: var(--font-main);
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.7;
            -webkit-font-smoothing: antialiased;
        }

        .main-container {
            max-width: 1280px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .main-layout { display: flex; gap: 30px; }
        .control-panel { flex: 1; position: sticky; top: 40px; align-self: flex-start; }
        .content-area { flex: 2.5; min-width: 0; }
        
        h1 {
            text-align: center;
            color: var(--text-color);
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 40px;
            letter-spacing: -1px;
        }
        h1 span { color: var(--primary-color); }
        
        .card {
            background-color: var(--card-background);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }
        .card h2 {
            font-size: 1.6rem;
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card p {
            color: var(--subtext-color);
            margin-bottom: 25px;
            font-size: 0.95rem;
        }
        
        label { font-weight: 500; margin-bottom: 8px; display: block; font-size: 0.9rem; color: #555; }
        
        input[type="text"], input[type="password"], textarea, select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 16px;
            background-color: #fdfdfd;
            transition: all 0.2s ease;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(0, 199, 83, 0.1);
            background-color: white;
        }
        textarea { resize: vertical; }
        
        button {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
            background-color: var(--primary-color);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 199, 83, 0.2);
        }
        button:hover {
            background-color: var(--primary-hover-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 199, 83, 0.3);
        }

        #rank-check-btn {
            font-size: 1.5rem;
            padding: 24px;
        }
        
        .button-group { display: flex; gap: 10px; }
        .button-group button { background-color: var(--subtext-color); box-shadow: none; }
        .button-group button:hover { background-color: #777; }
        .button-group button.primary { background-color: var(--info-color); box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2); }
        .button-group button.primary:hover { background-color: #2980b9; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(52, 152, 219, 0.3); }

        /* --- Loader with Progress Bar --- */
        .loader-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9); justify-content: center; align-items: center; flex-direction: column; z-index: 1001; backdrop-filter: blur(5px); }
        .loader-content { text-align: center; }
        .loader-spinner { border: 6px solid #e0e0e0; border-top: 6px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 25px auto; }
        .loader-content p { margin-bottom: 15px; font-size: 1.3rem; font-weight: 500; }
        .progress-bar-container { width: 300px; height: 12px; background-color: #e0e0e0; border-radius: 6px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background-color: var(--primary-color); transition: width 0.3s ease; }
        .progress-text { margin-top: 10px; font-size: 1rem; color: var(--subtext-color); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Modal, Dashboard Header, etc. */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 40px; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-content h2 { margin-top: 0; }
        .modal-content .button-group { margin-top: 20px; justify-content: flex-end; }
        
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; gap: 20px; margin-bottom: 15px; flex-wrap: wrap; }
        .dashboard-header h2 { flex-grow: 1; }
        .dashboard-header select { margin-bottom: 0; max-width: 250px; }

        @media (max-width: 992px) {
            .main-layout { flex-direction: column; }
            .control-panel { position: static; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>🕵️‍♂️ 순위 추적기 <span>v2.2</span></h1>
        <div class="main-layout">
            <aside class="control-panel">
                <div class="card">
                    <h2>📁 프로젝트</h2>
                    <p>추적할 프로젝트를 선택하거나 관리하세요.</p>
                    <select id="project-selector"></select>
                    <div class="button-group" style="margin-top:10px;">
                        <button id="new-project-btn" class="primary">➕ 새로 만들기</button>
                        <button id="edit-project-btn">✏️ 수정</button>
                        <button id="delete-project-btn" style="background-color: var(--danger-color);">🗑️ 삭제</button>
                    </div>
                </div>

                <div class="card">
                    <button id="rank-check-btn">🚀 START</button>
                </div>

                <div class="card">
                    <h2>📝 프로젝트 정보</h2>
                    <label for="my-product-name">내 상품</label>
                    <input type="text" id="my-product-name" placeholder="상품명">
                    <label for="store-name">내 스토어 (선택)</label>
                    <input type="text" id="store-name" placeholder="스토어명">
                    <label for="competitors">경쟁사 (상품명 :: 스토어명)</label>
                    <textarea id="competitors" rows="3" placeholder="경쟁사 상품 1 :: 스토어 1
경쟁사 상품 2"></textarea>
                    <label for="rank-keywords">키워드 (한 줄에 하나씩)</label>
                    <textarea id="rank-keywords" rows="5" placeholder="키워드 1
키워드 2"></textarea>
                     <p style="font-size: 0.8rem; text-align: right; margin-bottom: 0;">
                        <a href="#" id="save-changes-link">변경사항 저장</a>
                    </p>
                </div>
                
                <div class="card">
                    <h2>🔑 API 키</h2>
                    <p>API 키는 현재 브라우저에만 안전하게 저장됩니다.</p>
                    <input type="password" id="naver-client-id" placeholder="네이버 Client ID">
                    <input type="password" id="naver-client-secret" placeholder="네이버 Client Secret">
                    <button id="save-api-key-btn">API 키 저장</button>
                </div>
            </aside>

            <main class="content-area">
                <div class="card">
                    <div class="dashboard-header">
                        <h2>📈 순위 대시보드</h2>
                        <select id="keyword-chart-filter"></select>
                    </div>
                    <p id="dashboard-subtitle">프로젝트를 선택하면 순위 차트가 표시됩니다.</p>
                    <canvas id="rank-chart"></canvas>
                </div>

                <div id="results-container" class="card">
                    <h2>📊 결과 보고서</h2>
                    <div id="result-content">
                        <p>순위 추적 결과가 여기에 표시됩니다.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="loader" class="loader-container">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <p>탐정님이 수사 중입니다...</p>
            <div class="progress-bar-container">
                <div id="progress-bar" class="progress-bar"></div>
            </div>
            <p id="progress-text" class="progress-text">초기화 중...</p>
        </div>
    </div>

    <div id="project-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title">새 프로젝트 만들기</h2>
            <input type="text" id="modal-project-name" placeholder="프로젝트 이름 (예: 여름 신상품)">
            <label for="modal-my-product-name">내 상품</label>
            <input type="text" id="modal-my-product-name" placeholder="상품명">
            <label for="modal-store-name">내 스토어 (선택)</label>
            <input type="text" id="modal-store-name" placeholder="스토어명">
            <label for="modal-competitors">경쟁사 (상품명 :: 스토어명)</label>
            <textarea id="modal-competitors" rows="3" placeholder="경쟁사 1 :: 스토어 1"></textarea>
            <label for="modal-keywords">키워드 (한 줄에 하나씩)</label>
            <textarea id="modal-keywords" rows="5"></textarea>
            <div class="button-group">
                <button id="modal-cancel-btn">취소</button>
                <button id="modal-save-btn" class="primary">저장</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const MAX_REQUESTS = 50; // Maximum number of API calls per run

            let projects = [];
            let currentProjectId = null;
            let rankChart;

            const loader = document.getElementById('loader');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');

            const rankChartEl = document.getElementById('rank-chart').getContext('2d');
            const resultContent = document.getElementById('result-content');
            
            const saveApiKeyBtn = document.getElementById('save-api-key-btn');
            const clientIdEl = document.getElementById('naver-client-id');
            const clientSecretEl = document.getElementById('naver-client-secret');

            const projectSelector = document.getElementById('project-selector');
            const newProjectBtn = document.getElementById('new-project-btn');
            const editProjectBtn = document.getElementById('edit-project-btn');
            const deleteProjectBtn = document.getElementById('delete-project-btn');
            const saveChangesLink = document.getElementById('save-changes-link');
            
            const productNameEl = document.getElementById('my-product-name');
            const storeNameEl = document.getElementById('store-name');
            const competitorsEl = document.getElementById('competitors');
            const rankKeywordsEl = document.getElementById('rank-keywords');

            const projectModal = document.getElementById('project-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalProjectName = document.getElementById('modal-project-name');
            const modalProductName = document.getElementById('modal-my-product-name');
            const modalStoreName = document.getElementById('modal-store-name');
            const modalCompetitors = document.getElementById('modal-competitors');
            const modalKeywords = document.getElementById('modal-keywords');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalSaveBtn = document.getElementById('modal-save-btn');

            const rankCheckBtn = document.getElementById('rank-check-btn');
            
            const keywordChartFilter = document.getElementById('keyword-chart-filter');
            const dashboardSubtitle = document.getElementById('dashboard-subtitle');

            const getProjects = () => JSON.parse(localStorage.getItem('projects_v5')) || [];
            const saveProjects = (projs) => localStorage.setItem('projects_v5', JSON.stringify(projs));
            
            function initializeApp() {
                loadApiKeys();
                projects = getProjects();
                currentProjectId = localStorage.getItem('currentProjectId');
                renderProjectSelector();
                displayCurrentProjectInfo();
                updateDashboard();
            }

            function parseTextToCompetitors(text) {
                return text.split('\n').map(line => {
                    const parts = line.split('::').map(p => p.trim());
                    if (!parts[0]) return null;
                    return { product: parts[0], store: parts[1] || '' };
                }).filter(Boolean);
            }

            function formatCompetitorsToText(competitors) {
                if (!competitors) return '';
                return competitors.map(c => c.store ? `${c.product} :: ${c.store}` : c.product).join('\n');
            }

            function renderProjectSelector() {
                projectSelector.innerHTML = '';
                if (projects.length === 0) {
                    projectSelector.innerHTML = '<option>새 프로젝트를 만들어주세요</option>';
                    return;
                }
                projects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    projectSelector.appendChild(option);
                });
                
                if (currentProjectId && projects.some(p => p.id === currentProjectId)) {
                    projectSelector.value = currentProjectId;
                } else if (projects.length > 0) {
                    currentProjectId = projects[0].id;
                    projectSelector.value = currentProjectId;
                    localStorage.setItem('currentProjectId', currentProjectId);
                }
            }

            function displayCurrentProjectInfo() {
                if (!currentProjectId || projects.length === 0) {
                    productNameEl.value = ''; storeNameEl.value = ''; competitorsEl.value = ''; rankKeywordsEl.value = '';
                    return;
                }
                const project = projects.find(p => p.id === currentProjectId);
                if (project) {
                    productNameEl.value = project.productName || '';
                    storeNameEl.value = project.storeName || '';
                    competitorsEl.value = formatCompetitorsToText(project.competitors);
                    rankKeywordsEl.value = (project.keywords || []).join('\n');
                }
            }
            
            function handleProjectSelection() {
                currentProjectId = projectSelector.value;
                localStorage.setItem('currentProjectId', currentProjectId);
                displayCurrentProjectInfo();
                updateDashboard();
                resultContent.innerHTML = '<p>프로젝트가 변경되었습니다. 순위 추적을 시작하세요.</p>';
            }

            function saveCurrentProjectInfo() {
                 if (!currentProjectId) return;
                const projectIndex = projects.findIndex(p => p.id === currentProjectId);
                if (projectIndex > -1) {
                    projects[projectIndex].productName = productNameEl.value.trim();
                    projects[projectIndex].storeName = storeNameEl.value.trim();
                    projects[projectIndex].competitors = parseTextToCompetitors(competitorsEl.value);
                    projects[projectIndex].keywords = rankKeywordsEl.value.split('\n').map(k => k.trim()).filter(Boolean);
                    saveProjects(projects);
                    alert('프로젝트 정보가 성공적으로 저장되었습니다.');
                }
            }
            
            function handleDeleteProject() {
                if (!currentProjectId || projects.length === 0) return alert('삭제할 프로젝트가 선택되지 않았습니다.');
                if (confirm(`'${projects.find(p=>p.id===currentProjectId).name}' 프로젝트를 정말 삭제하시겠습니까? 관련 데이터가 모두 삭제됩니다.`)) {
                    projects = projects.filter(p => p.id !== currentProjectId);
                    currentProjectId = projects.length > 0 ? projects[0].id : null;
                    localStorage.setItem('currentProjectId', currentProjectId);
                    saveProjects(projects);
                    renderProjectSelector();
                    displayCurrentProjectInfo();
                    updateDashboard();
                }
            }

            let editingProjectId = null;
            function openModal(mode = 'new') {
                projectModal.style.display = 'flex';
                if (mode === 'edit' && currentProjectId) {
                    const project = projects.find(p => p.id === currentProjectId);
                    if (!project) return;
                    modalTitle.textContent = '프로젝트 수정';
                    editingProjectId = project.id;
                    modalProjectName.value = project.name;
                    modalProductName.value = project.productName || '';
                    modalStoreName.value = project.storeName || '';
                    modalCompetitors.value = formatCompetitorsToText(project.competitors);
                    modalKeywords.value = (project.keywords || []).join('\n');
                } else {
                    modalTitle.textContent = '새 프로젝트 만들기';
                    editingProjectId = null;
                    modalProjectName.value = '';
                    modalProductName.value = '';
                    modalStoreName.value = '';
                    modalCompetitors.value = '';
                    modalKeywords.value = '';
                }
            }

            function closeModal() {
                projectModal.style.display = 'none';
            }

            function handleSaveProject() {
                const name = modalProjectName.value.trim();
                const productName = modalProductName.value.trim();
                if (!name || !productName) return alert('프로젝트 이름과 내 상품명은 필수입니다.');

                const projectData = {
                    name,
                    productName,
                    storeName: modalStoreName.value.trim(),
                    competitors: parseTextToCompetitors(modalCompetitors.value),
                    keywords: modalKeywords.value.split('\n').map(k => k.trim()).filter(Boolean),
                };

                if (editingProjectId) {
                    const projectIndex = projects.findIndex(p => p.id === editingProjectId);
                    if (projectIndex > -1) {
                        projects[projectIndex] = { ...projects[projectIndex], ...projectData };
                    }
                } else {
                    const newProject = {
                        id: `proj_${Date.now()}`,
                        ...projectData,
                        rankData: []
                    };
                    projects.push(newProject);
                    currentProjectId = newProject.id;
                    localStorage.setItem('currentProjectId', currentProjectId);
                }
                saveProjects(projects);
                renderProjectSelector();
                displayCurrentProjectInfo();
                updateDashboard();
                closeModal();
            }

            function saveApiKeys() {
                if(clientIdEl.value && clientSecretEl.value) {
                    localStorage.setItem('naverClientId', clientIdEl.value);
                    localStorage.setItem('naverClientSecret', clientSecretEl.value);
                    alert('API 키가 성공적으로 저장되었습니다!');
                } else {
                    alert('Client ID와 Client Secret을 모두 입력해주세요.');
                }
            }

            function loadApiKeys() {
                clientIdEl.value = localStorage.getItem('naverClientId') || '';
                clientSecretEl.value = localStorage.getItem('naverClientSecret') || '';
            }

            function updateLoaderProgress(completed, total) {
                const percentage = total > 0 ? (completed / total) * 100 : 0;
                progressBar.style.width = `${percentage}%`;
                progressText.textContent = `처리 중... (${completed}/${total})`;
            }

            async function handleRankCheck() {
                if (!currentProjectId) return alert('먼저 프로젝트를 선택하거나 생성해주세요.');
                
                const project = projects.find(p => p.id === currentProjectId);
                if (!project || !project.productName) return alert('내 상품명을 입력해주세요.');
                if (!project.keywords || project.keywords.length === 0) return alert('추적할 키워드를 입력해주세요.');

                const userClientId = localStorage.getItem('naverClientId');
                const userClientSecret = localStorage.getItem('naverClientSecret');
                if (!userClientId || !userClientSecret) return alert('API 키를 먼저 설정하고 저장해주세요.');

                const productsToCheck = [
                    { product: project.productName, store: project.storeName }, 
                    ...(project.competitors || [])
                ];
                
                const totalTasks = productsToCheck.length * project.keywords.length;

                if (totalTasks > MAX_REQUESTS) {
                    return alert(`요청이 너무 많습니다! 한 번에 최대 ${MAX_REQUESTS}개까지만 조회가 가능합니다. (현재 요청: ${totalTasks}개) 키워드나 경쟁사 수를 줄여주세요.`);
                }
                
                let completedTasks = 0;
                loader.style.display = 'flex';
                updateLoaderProgress(completedTasks, totalTasks);
                resultContent.innerHTML = '<ul></ul>';
                
                for (const keyword of project.keywords) {
                    resultContent.querySelector('ul').innerHTML += `<li><strong>--- 키워드 추적 중: '${keyword}' ---</strong></li>`;
                    for (const item of productsToCheck) {
                        const rank = await fetchRankFromNetlify(keyword, item.product, item.store, userClientId, userClientSecret);
                        
                        completedTasks++;
                        updateLoaderProgress(completedTasks, totalTasks);
                        
                        const today = new Date().toISOString().split('T')[0];
                        const rankText = rank > 0 ? `${rank}위` : '1000위 밖';
                        
                        const li = document.createElement('li');
                        const storeText = item.store ? ` (${item.store})` : '';
                        li.textContent = `[${item.product}${storeText}] ${rankText}`;
                        resultContent.querySelector('ul').appendChild(li);

                        if (rank > 0) {
                            const productNameWithStore = item.store ? `${item.product} (${item.store})` : item.product;
                            const existingIndex = project.rankData.findIndex(d => d.date === today && d.keyword === keyword && d.productName === productNameWithStore);
                            if (existingIndex > -1) {
                                project.rankData[existingIndex].rank = rank;
                            } else {
                                project.rankData.push({ date: today, keyword, rank, productName: productNameWithStore });
                            }
                        }
                    }
                }
                saveProjects(projects);
                loader.style.display = 'none';
                updateDashboard();
            }
            
            async function fetchRankFromNetlify(keyword, productName, storeName, clientId, clientSecret) {
                try {
                    const params = new URLSearchParams({ keyword, product: productName, store: storeName, clientId, clientSecret });
                    const response = await fetch(`/.netlify/functions/get-rank?${params.toString()}`);
                    if (!response.ok) throw new Error(`서버 오류: ${response.status}`);
                    const data = await response.json();
                    return data.rank;
                } catch (error) {
                    console.error("API 오류:", error);
                     resultContent.querySelector('ul').innerHTML += `<li style="color: red;">🚨 '${productName}' 조회 중 오류 발생!</li>`;
                    return -1;
                }
            }

            function updateDashboard() {
                 if (!currentProjectId) {
                     dashboardSubtitle.textContent = '프로젝트를 선택하면 순위 차트가 표시됩니다.';
                     if (rankChart) rankChart.destroy();
                     keywordChartFilter.innerHTML = '';
                     return;
                 }
                const project = projects.find(p => p.id === currentProjectId);
                dashboardSubtitle.textContent = `'${project.name}' 프로젝트 대시보드`;

                const uniqueKeywords = [...new Set((project.rankData || []).map(d => d.keyword))];
                
                const currentFilterValue = keywordChartFilter.value;
                keywordChartFilter.innerHTML = '<option value="">-- 차트를 볼 키워드 선택 --</option>';
                uniqueKeywords.forEach(k => {
                    const option = document.createElement('option');
                    option.value = k;
                    option.textContent = k;
                    keywordChartFilter.appendChild(option);
                });
                
                if (uniqueKeywords.includes(currentFilterValue)) {
                    keywordChartFilter.value = currentFilterValue;
                }

                if (rankChart) rankChart.destroy();
                
                if(keywordChartFilter.value) {
                    drawChartForKeyword(keywordChartFilter.value);
                }
            }
            
            function drawChartForKeyword(selectedKeyword) {
                const project = projects.find(p => p.id === currentProjectId);
                if (!project || !selectedKeyword) {
                     if (rankChart) { rankChart.destroy(); rankChart = null; }
                    return;
                }
                const chartData = processDataForChart(project.rankData, selectedKeyword);
                
                if (rankChart) rankChart.destroy();

                rankChart = new Chart(rankChartEl, {
                    type: 'line', data: chartData,
                    options: { scales: { y: { reverse: true, beginAtZero: false } } }
                });
            }

            function processDataForChart(data, selectedKeyword) {
                if (!data || data.length === 0) return { labels: [], datasets: [] };
                
                const project = projects.find(p => p.id === currentProjectId);
                const myProductName = project.storeName ? `${project.productName} (${project.storeName})` : project.productName;
                
                const filteredData = data.filter(d => d.keyword === selectedKeyword);
                const labels = [...new Set(filteredData.map(item => item.date))].sort();
                const products = [...new Set(filteredData.map(item => item.productName))];
                
                const datasets = products.map((productName, index) => {
                    const productData = labels.map(label => {
                        const entry = filteredData.find(d => d.date === label && d.productName === productName);
                        return entry ? entry.rank : null;
                    });
                    
                    const isMyProduct = productName === myProductName;
                    const color = isMyProduct ? 'hsl(210, 80%, 55%)' : `hsl(${ (index * 60) % 360 }, 60%, 65%)`;

                    return { 
                        label: productName, 
                        data: productData, 
                        borderColor: color, 
                        backgroundColor: color, 
                        fill: false, 
                        tension: 0.1,
                        borderWidth: isMyProduct ? 4 : 2,
                        pointRadius: isMyProduct ? 5 : 3,
                    };
                });
                return { labels, datasets };
            }

            // --- Event Listeners ---
            saveApiKeyBtn.addEventListener('click', saveApiKeys);
            newProjectBtn.addEventListener('click', () => openModal('new'));
            editProjectBtn.addEventListener('click', () => openModal('edit'));
            deleteProjectBtn.addEventListener('click', handleDeleteProject);
            projectSelector.addEventListener('change', handleProjectSelection);
            saveChangesLink.addEventListener('click', (e) => {
                e.preventDefault();
                saveCurrentProjectInfo();
            });
            modalCancelBtn.addEventListener('click', closeModal);
            modalSaveBtn.addEventListener('click', handleSaveProject);
            rankCheckBtn.addEventListener('click', handleRankCheck);
            keywordChartFilter.addEventListener('change', (e) => drawChartForKeyword(e.target.value));

            initializeApp();
        });
    </script>
</body>
</html>