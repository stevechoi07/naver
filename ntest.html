<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„¤ì´ë²„ ìˆœìœ„ íƒì • ì¡°ì¢…ê¸° v1.5</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* [ì´ì „ CSS ì½”ë“œëŠ” ì—¬ê¸°ì— ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤...] */
        /* ----------------------------------------------------------------------------- */
        /* ğŸ•µï¸â€â™‚ï¸ ë„¤ì´ë²„ ìˆœìœ„ íƒì • ì¡°ì¢…ê¸° v1.5 - style.css                               */
        /* ----------------------------------------------------------------------------- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        :root {
            --primary-color: #03C75A; /* ë„¤ì´ë²„ ê·¸ë¦° */
            --background-color: #f4f6f8;
            --card-background: #ffffff;
            --text-color: #333;
            --subtext-color: #666;
            --border-color: #e0e0e0;
            --danger-color: #EF233C;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }

        /* --- 2ë‹¨ ë ˆì´ì•„ì›ƒ --- */
        .main-layout { display: flex; max-width: 1200px; margin: 30px auto; gap: 30px; padding: 0 20px; }
        .control-panel { flex: 1; position: sticky; top: 30px; align-self: flex-start; }
        .content-area { flex: 2; min-width: 0; }
        
        h1, h2 { font-weight: 700; margin-bottom: 10px; }
        h1 { text-align: center; color: var(--primary-color); font-size: 2rem; margin-bottom: 30px; }
        
        .card { background-color: var(--card-background); border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .card h2 { font-size: 1.5rem; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 20px; }
        .card p { color: var(--subtext-color); margin-bottom: 20px; font-size: 0.9rem; }
        
        input[type="text"], input[type="password"], textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; margin-bottom: 15px; transition: border-color 0.3s, box-shadow 0.3s; }
        input[type="text"]:focus, input[type="password"]:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(3, 199, 90, 0.2); }
        textarea { resize: vertical; }
        
        button { display: block; width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 700; color: white; background-color: var(--primary-color); cursor: pointer; transition: background-color 0.3s, transform 0.2s; }
        button:hover { background-color: #02b350; transform: translateY(-2px); }
        
        .dashboard-controls { display: flex; gap: 15px; margin-top: 20px; }
        #clear-data-btn { background-color: var(--danger-color); }
        #clear-data-btn:hover { background-color: #d90429; }
        
        .loader-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); justify-content: center; align-items: center; flex-direction: column; z-index: 999; }
        .loader { border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        .loader-container p { margin-top: 20px; font-size: 1.2rem; font-weight: 500; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #results-container ul { list-style-position: inside; padding-left: 10px; }
        #results-container li { margin-bottom: 8px; }

        #debug-container { margin-top: 20px; background-color: #2c2c2c; color: #f1f1f1; border-radius: 8px; padding: 15px; }
        #debug-container h2 { color: var(--primary-color); border-bottom: 1px solid #555; padding-bottom: 10px;}
        #debug-log { font-family: 'Courier New', Courier, monospace; white-space: pre-wrap; word-break: break-all; max-height: 300px; overflow-y: auto; font-size: 0.85rem; }
        
        @media (max-width: 992px) {
            .main-layout { flex-direction: column; }
            .control-panel { position: static; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>ğŸ•µï¸â€â™‚ï¸ ë„¤ì´ë²„ ìˆœìœ„ íƒì • ì¡°ì¢…ê¸° v1.5</h1>
        <div class="main-layout">
            <aside class="control-panel">
                <div class="card">
                    <h2>ğŸ”‘ API í‚¤ ì„¤ì •</h2>
                    <p>ì‚¬ìš©ìë‹˜ì˜ ë„¤ì´ë²„ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì…ë ¥ëœ ì •ë³´ëŠ” ì´ ë¸Œë¼ìš°ì €ì—ë§Œ ì•ˆì „í•˜ê²Œ ì €ì¥ë©ë‹ˆë‹¤.</p>
                    <input type="password" id="naver-client-id" placeholder="ë„¤ì´ë²„ Client ID">
                    <input type="password" id="naver-client-secret" placeholder="ë„¤ì´ë²„ Client Secret">
                    <button id="save-api-key-btn">API í‚¤ ì €ì¥</button>
                </div>
                
                <div class="card">
                    <h2>ğŸ† ìˆœìœ„ ì¶”ì  ëª¨ë“œ</h2>
                    <p>ì¶”ì í•  í‚¤ì›Œë“œë¥¼ í•œ ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥í•˜ì„¸ìš”.</p>
                    <textarea id="rank-keywords" rows="5" placeholder="ì˜ˆ:\nê°•ì•„ì§€ ê°„ì‹\nê³ ì–‘ì´ ì¥ë‚œê°\ní–„ìŠ¤í„° ì³‡ë°”í€´"></textarea>
                    <input type="text" id="product-name" placeholder="ë‚´ ìƒí’ˆëª… (ì¼ë¶€ë§Œ í¬í•¨ë¼ë„ OK)">
                    <input type="text" id="store-name" placeholder="ë‚´ ìŠ¤í† ì–´ëª… (ì„ íƒ ì‚¬í•­)">
                    <button id="rank-check-btn">ë‚´ ìˆœìœ„ ì¶”ì !</button>
                </div>
            </aside>

            <main class="content-area">
                <div class="card">
                    <h2>ğŸ“ˆ ìˆœìœ„ ë³€í™” ëŒ€ì‹œë³´ë“œ</h2>
                    <p>ì €ì¥ëœ ìˆœìœ„ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í‚¤ì›Œë“œë³„ ìˆœìœ„ ë³€í™” ì¶”ì´ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</p>
                    <canvas id="rank-chart"></canvas>
                    <div class="dashboard-controls">
                        <button id="update-dashboard-btn">ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨</button>
                        <button id="clear-data-btn">ê¸°ë¡ ì „ì²´ ì‚­ì œ</button>
                    </div>
                </div>

                <div id="results-container" class="card">
                    <h2>ğŸ“Š ê²°ê³¼ ë³´ê³ ì„œ</h2>
                    <div id="result-content">
                        <p>ì´ê³³ì— ìˆœìœ„ í™•ì¸ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
                 <div id="debug-container">
                    <h2>ğŸ ê°œë°œì ë””ë²„ê¹… ë¡œê·¸</h2>
                    <pre id="debug-log"></pre>
                </div>
            </main>
        </div>
    </div>

    <div id="loader" class="loader-container">
        <div class="loader"></div>
        <p>íƒì •ë‹˜ì´ ì—´ì‹¬íˆ ìˆ˜ì‚¬ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const rankKeywordsEl = document.getElementById('rank-keywords');
            const productNameEl = document.getElementById('product-name');
            const storeNameEl = document.getElementById('store-name');
            const rankCheckBtn = document.getElementById('rank-check-btn');
            const loader = document.getElementById('loader');
            const resultContent = document.getElementById('result-content');
            const rankChartEl = document.getElementById('rank-chart').getContext('2d');
            const updateDashboardBtn = document.getElementById('update-dashboard-btn');
            const clearDataBtn = document.getElementById('clear-data-btn');
            const saveApiKeyBtn = document.getElementById('save-api-key-btn');
            const clientIdEl = document.getElementById('naver-client-id');
            const clientSecretEl = document.getElementById('naver-client-secret');

            let rankChart;

            // --- API í‚¤ ê´€ë¦¬ ---
            function saveApiKeys() {
                const clientId = clientIdEl.value;
                const clientSecret = clientSecretEl.value;
                if(clientId && clientSecret) {
                    localStorage.setItem('naverClientId', clientId);
                    localStorage.setItem('naverClientSecret', clientSecret);
                    logDebug('API í‚¤ê°€ ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    alert('API í‚¤ê°€ ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    alert('Client IDì™€ Client Secretì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
            }

            function loadApiKeys() {
                const savedId = localStorage.getItem('naverClientId');
                const savedSecret = localStorage.getItem('naverClientSecret');
                if (savedId && savedSecret) {
                    clientIdEl.value = savedId;
                    clientSecretEl.value = savedSecret;
                    logDebug('ì €ì¥ëœ API í‚¤ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                }
            }
            
            saveApiKeyBtn.addEventListener('click', saveApiKeys);

            // --- ìˆœìœ„ ë°ì´í„° ê´€ë¦¬ ---
            const getRankData = () => JSON.parse(localStorage.getItem('rankData')) || [];
            const saveRankData = (data) => localStorage.setItem('rankData', JSON.stringify(data));

            // --- ë©”ì¸ ë¡œì§ ---
            async function handleRankCheck() {
                const keywords = rankKeywordsEl.value.split('\n').filter(k => k.trim() !== '');
                const productName = productNameEl.value.trim();

                if (keywords.length === 0 || !productName) {
                    alert('í‚¤ì›Œë“œì™€ ìƒí’ˆëª…ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                const userClientId = localStorage.getItem('naverClientId');
                const userClientSecret = localStorage.getItem('naverClientSecret');

                if (!userClientId || !userClientSecret) {
                    alert('API í‚¤ë¥¼ ë¨¼ì € ì„¤ì •í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                loader.style.display = 'flex';
                resultContent.innerHTML = '<ul></ul>';
                
                for (const keyword of keywords) {
                    const rank = await fetchRankFromNetlify(keyword, productName, storeNameEl.value.trim(), userClientId, userClientSecret);
                    const today = new Date().toISOString().split('T')[0];
                    const rankText = rank > 0 ? `${rank}ìœ„` : 'ìˆœìœ„ê¶Œ ë°–';
                    
                    const li = document.createElement('li');
                    li.textContent = `[${today}] '${keyword}': ${rankText}`;
                    resultContent.querySelector('ul').appendChild(li);

                    if (rank > 0) {
                        const currentData = getRankData();
                        currentData.push({ date: today, keyword, rank });
                        saveRankData(currentData);
                    }
                }
                
                loader.style.display = 'none';
                updateDashboard();
            }

            rankCheckBtn.addEventListener('click', handleRankCheck);

            // --- ëŒ€ì‹œë³´ë“œ ë° ì°¨íŠ¸ ---
            function updateDashboard() {
                const data = getRankData();
                logDebug(`${data.length}ê°œì˜ ìˆœìœ„ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ëŒ€ì‹œë³´ë“œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.`);
                const chartData = processDataForChart(data);

                if (rankChart) {
                    rankChart.destroy();
                }

                rankChart = new Chart(rankChartEl, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                reverse: true,
                                beginAtZero: false
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y}ìœ„`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            updateDashboardBtn.addEventListener('click', updateDashboard);

            function processDataForChart(data) {
                if (!data || data.length === 0) return { labels: [], datasets: [] };

                const labels = [...new Set(data.map(item => item.date))].sort();
                const keywords = [...new Set(data.map(item => item.keyword))];
                const datasets = keywords.map(keyword => {
                    const keywordData = labels.map(label => {
                        const entry = data.find(d => d.date === label && d.keyword === keyword);
                        return entry ? entry.rank : null;
                    });
                    const color = `hsl(${Math.random() * 360}, 70%, 50%)`;
                    return {
                        label: keyword,
                        data: keywordData,
                        borderColor: color,
                        backgroundColor: color,
                        fill: false,
                        tension: 0.1
                    };
                });
                return { labels, datasets };
            }

            function handleClearData() {
                if (confirm('ì •ë§ë¡œ ëª¨ë“  ìˆœìœ„ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                    localStorage.removeItem('rankData');
                    logDebug('ëª¨ë“  ìˆœìœ„ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    updateDashboard();
                }
            }
            clearDataBtn.addEventListener('click', handleClearData);
            
            // --- API í˜¸ì¶œ ---
            async function fetchRankFromNetlify(keyword, productName, storeName, clientId, clientSecret) {
                logDebug(`(API í˜¸ì¶œ) Keyword: ${keyword}, Product: ${productName}`);
                try {
                    const params = new URLSearchParams({
                        keyword: keyword,
                        product: productName,
                        store: storeName,
                        clientId: clientId,
                        clientSecret: clientSecret
                    });
                    
                    const response = await fetch(`/.netlify/functions/get-rank?${params.toString()}`);
                    
                    if (!response.ok) {
                        throw new Error(`ì„œë²„ ì—ëŸ¬ ë°œìƒ: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    return data.rank;

                } catch (error) {
                    logDebug(`API í˜¸ì¶œ ì‹¤íŒ¨: ${error.message}`);
                    resultContent.querySelector('ul').innerHTML += `<li style="color: red;">ğŸš¨ '${keyword}' ìˆœìœ„ ì¡°íšŒ ì¤‘ ì„œë²„ ì—ëŸ¬ ë°œìƒ!</li>`;
                    return -1;
                }
            }

            // --- ë””ë²„ê¹… íˆ´ ---
            function logDebug(message) {
                const debugLog = document.getElementById('debug-log');
                const timestamp = new Date().toLocaleTimeString();
                debugLog.innerHTML += `[${timestamp}] ${message}\n`;
                console.log(`[DEBUG] ${message}`);
            }

            // --- ì´ˆê¸°í™” ---
            loadApiKeys();
            updateDashboard();
            logDebug("ìˆœìœ„ íƒì • ì¡°ì¢…ê¸° v1.5ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        });
    </script>
</body>
</html>