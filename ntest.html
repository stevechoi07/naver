<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>네이버 순위 탐정 조종기 v1.6</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* [이전 CSS 코드는 여기에 그대로 유지됩니다...] */
        /* ----------------------------------------------------------------------------- */
        /* 🕵️‍♂️ 네이버 순위 탐정 조종기 v1.6 - style.css                               */
        /* ----------------------------------------------------------------------------- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        :root {
            --primary-color: #03C75A; /* 네이버 그린 */
            --background-color: #f4f6f8;
            --card-background: #ffffff;
            --text-color: #333;
            --subtext-color: #666;
            --border-color: #e0e0e0;
            --danger-color: #EF233C;
            --info-color: #007bff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }

        .main-layout { display: flex; max-width: 1200px; margin: 30px auto; gap: 30px; padding: 0 20px; }
        .control-panel { flex: 1; position: sticky; top: 30px; align-self: flex-start; }
        .content-area { flex: 2; min-width: 0; }
        
        h1, h2 { font-weight: 700; margin-bottom: 10px; }
        h1 { text-align: center; color: var(--primary-color); font-size: 2rem; margin-bottom: 30px; }
        
        .card { background-color: var(--card-background); border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .card h2 { font-size: 1.5rem; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 20px; }
        .card p { color: var(--subtext-color); margin-bottom: 20px; font-size: 0.9rem; }
        
        input[type="text"], input[type="password"], textarea, select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; margin-bottom: 15px; background-color: white; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(3, 199, 90, 0.2); }
        textarea { resize: vertical; }
        
        button { display: block; width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 700; color: white; background-color: var(--primary-color); cursor: pointer; transition: background-color 0.3s, transform 0.2s; }
        button:hover { background-color: #02b350; transform: translateY(-2px); }
        
        .button-group { display: flex; gap: 10px; }
        .button-group button { background-color: var(--subtext-color); }
        .button-group button.primary { background-color: var(--info-color); }
        
        .loader-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); justify-content: center; align-items: center; flex-direction: column; z-index: 1001; }
        .loader { border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        .loader-container p { margin-top: 20px; font-size: 1.2rem; font-weight: 500; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* --- Modal Styles --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-content h2 { margin-top: 0; }
        .modal-content .button-group { margin-top: 20px; justify-content: flex-end; }
        
        @media (max-width: 992px) {
            .main-layout { flex-direction: column; }
            .control-panel { position: static; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>🕵️‍♂️ 순위 탐정 관제 센터 v1.6</h1>
        <div class="main-layout">
            <aside class="control-panel">
                <div class="card">
                    <h2>📁 프로젝트 관리</h2>
                    <p>분석할 프로젝트를 선택하거나 새로 만드세요.</p>
                    <select id="project-selector"></select>
                    <div class="button-group">
                        <button id="new-project-btn" class="primary">➕ 새로 만들기</button>
                        <button id="edit-project-btn">✏️ 수정</button>
                        <button id="delete-project-btn" style="background-color: var(--danger-color);">🗑️ 삭제</button>
                    </div>
                </div>

                <div class="card">
                    <h2>📝 현재 프로젝트 정보</h2>
                    <input type="text" id="product-name" placeholder="상품명">
                    <input type="text" id="store-name" placeholder="스토어명 (선택)">
                    <textarea id="rank-keywords" rows="5" placeholder="추적할 키워드 (한 줄에 하나씩)"></textarea>
                     <p style="font-size: 0.8rem; text-align: right;">
                        <a href="#" id="save-changes-link">변경사항 저장하기</a>
                    </p>
                </div>
                
                <div class="card">
                    <h2>🔑 API 키 설정</h2>
                    <p>API 키는 이 브라우저에만 안전하게 저장됩니다.</p>
                    <input type="password" id="naver-client-id" placeholder="네이버 Client ID">
                    <input type="password" id="naver-client-secret" placeholder="네이버 Client Secret">
                    <button id="save-api-key-btn">API 키 저장</button>
                </div>
            </aside>

            <main class="content-area">
                <div class="card">
                    <button id="rank-check-btn" style="font-size: 1.5rem; padding: 20px;">🚀 현재 프로젝트 순위 추적 시작!</button>
                </div>

                <div class="card">
                    <h2>📈 순위 변화 대시보드</h2>
                    <p id="dashboard-subtitle">프로젝트를 선택하면 순위 변화 그래프가 표시됩니다.</p>
                    <canvas id="rank-chart"></canvas>
                </div>

                <div id="results-container" class="card">
                    <h2>📊 결과 보고서</h2>
                    <div id="result-content">
                        <p>이곳에 순위 확인 결과가 표시됩니다.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Loader -->
    <div id="loader" class="loader-container">
        <div class="loader"></div>
        <p>탐정님이 열심히 수사 중입니다... 잠시만 기다려주세요!</p>
    </div>

    <!-- Project Modal -->
    <div id="project-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title">새 프로젝트 만들기</h2>
            <input type="text" id="modal-project-name" placeholder="프로젝트 이름 (예: 여름 신상 의류)">
            <input type="text" id="modal-product-name" placeholder="상품명">
            <input type="text" id="modal-store-name" placeholder="스토어명 (선택)">
            <textarea id="modal-keywords" rows="5" placeholder="관련 키워드 (한 줄에 하나씩)"></textarea>
            <div class="button-group">
                <button id="modal-cancel-btn">취소</button>
                <button id="modal-save-btn" class="primary">저장</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 전역 변수 및 DOM 요소 ---
            let projects = [];
            let currentProjectId = null;
            let rankChart;

            const loader = document.getElementById('loader');
            const rankChartEl = document.getElementById('rank-chart').getContext('2d');
            const resultContent = document.getElementById('result-content');
            
            // API Key elements
            const saveApiKeyBtn = document.getElementById('save-api-key-btn');
            const clientIdEl = document.getElementById('naver-client-id');
            const clientSecretEl = document.getElementById('naver-client-secret');

            // Project management elements
            const projectSelector = document.getElementById('project-selector');
            const newProjectBtn = document.getElementById('new-project-btn');
            const editProjectBtn = document.getElementById('edit-project-btn');
            const deleteProjectBtn = document.getElementById('delete-project-btn');
            const saveChangesLink = document.getElementById('save-changes-link');
            
            // Project info display elements
            const productNameEl = document.getElementById('product-name');
            const storeNameEl = document.getElementById('store-name');
            const rankKeywordsEl = document.getElementById('rank-keywords');

            // Modal elements
            const projectModal = document.getElementById('project-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalProjectName = document.getElementById('modal-project-name');
            const modalProductName = document.getElementById('modal-product-name');
            const modalStoreName = document.getElementById('modal-store-name');
            const modalKeywords = document.getElementById('modal-keywords');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalSaveBtn = document.getElementById('modal-save-btn');

            // Main action button
            const rankCheckBtn = document.getElementById('rank-check-btn');

            // --- 데이터 관리 ---
            const getProjects = () => JSON.parse(localStorage.getItem('projects_v1')) || [];
            const saveProjects = (projs) => localStorage.setItem('projects_v1', JSON.stringify(projs));
            
            // --- 초기화 ---
            function initializeApp() {
                loadApiKeys();
                projects = getProjects();
                currentProjectId = localStorage.getItem('currentProjectId');
                renderProjectSelector();
                displayCurrentProjectInfo();
                updateDashboard();
            }

            // --- 프로젝트 관리 UI ---
            function renderProjectSelector() {
                projectSelector.innerHTML = '';
                if (projects.length === 0) {
                    projectSelector.innerHTML = '<option>프로젝트를 만들어주세요</option>';
                    return;
                }
                projects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    projectSelector.appendChild(option);
                });
                
                if (currentProjectId && projects.some(p => p.id === currentProjectId)) {
                    projectSelector.value = currentProjectId;
                } else if (projects.length > 0) {
                    currentProjectId = projects[0].id;
                    projectSelector.value = currentProjectId;
                    localStorage.setItem('currentProjectId', currentProjectId);
                }
            }

            function displayCurrentProjectInfo() {
                if (!currentProjectId || projects.length === 0) {
                    productNameEl.value = '';
                    storeNameEl.value = '';
                    rankKeywordsEl.value = '';
                    return;
                }
                const project = projects.find(p => p.id === currentProjectId);
                if (project) {
                    productNameEl.value = project.productName;
                    storeNameEl.value = project.storeName;
                    rankKeywordsEl.value = project.keywords.join('\n');
                }
            }

            // --- 프로젝트 데이터 조작 ---
            function handleProjectSelection() {
                currentProjectId = projectSelector.value;
                localStorage.setItem('currentProjectId', currentProjectId);
                displayCurrentProjectInfo();
                updateDashboard();
                resultContent.innerHTML = '<p>프로젝트가 변경되었습니다. 순위 추적을 시작하세요.</p>';
            }

            function saveCurrentProjectInfo() {
                 if (!currentProjectId) return;
                const projectIndex = projects.findIndex(p => p.id === currentProjectId);
                if (projectIndex > -1) {
                    projects[projectIndex].productName = productNameEl.value.trim();
                    projects[projectIndex].storeName = storeNameEl.value.trim();
                    projects[projectIndex].keywords = rankKeywordsEl.value.split('\n').map(k => k.trim()).filter(Boolean);
                    saveProjects(projects);
                    alert('현재 프로젝트 정보가 저장되었습니다.');
                }
            }
            
            function handleDeleteProject() {
                if (!currentProjectId || projects.length === 0) return alert('삭제할 프로젝트가 없습니다.');
                if (confirm(`'${projects.find(p=>p.id===currentProjectId).name}' 프로젝트를 정말 삭제하시겠습니까?`)) {
                    projects = projects.filter(p => p.id !== currentProjectId);
                    currentProjectId = projects.length > 0 ? projects[0].id : null;
                    localStorage.setItem('currentProjectId', currentProjectId);
                    saveProjects(projects);
                    renderProjectSelector();
                    displayCurrentProjectInfo();
                    updateDashboard();
                }
            }

            // --- 모달 관리 ---
            let editingProjectId = null;
            function openModal(mode = 'new') {
                projectModal.style.display = 'flex';
                if (mode === 'edit' && currentProjectId) {
                    const project = projects.find(p => p.id === currentProjectId);
                    if (!project) return;
                    modalTitle.textContent = '프로젝트 수정';
                    editingProjectId = project.id;
                    modalProjectName.value = project.name;
                    modalProductName.value = project.productName;
                    modalStoreName.value = project.storeName;
                    modalKeywords.value = project.keywords.join('\n');
                } else {
                    modalTitle.textContent = '새 프로젝트 만들기';
                    editingProjectId = null;
                    modalProjectName.value = '';
                    modalProductName.value = '';
                    modalStoreName.value = '';
                    modalKeywords.value = '';
                }
            }

            function closeModal() {
                projectModal.style.display = 'none';
            }


            function handleSaveProject() {
                const name = modalProjectName.value.trim();
                const productName = modalProductName.value.trim();
                if (!name || !productName) return alert('프로젝트 이름과 상품명은 필수입니다.');

                if (editingProjectId) { // 수정 모드
                    const projectIndex = projects.findIndex(p => p.id === editingProjectId);
                    if (projectIndex > -1) {
                        projects[projectIndex].name = name;
                        projects[projectIndex].productName = productName;
                        projects[projectIndex].storeName = modalStoreName.value.trim();
                        projects[projectIndex].keywords = modalKeywords.value.split('\n').map(k => k.trim()).filter(Boolean);
                    }
                } else { // 생성 모드
                    const newProject = {
                        id: `proj_${Date.now()}`,
                        name,
                        productName,
                        storeName: modalStoreName.value.trim(),
                        keywords: modalKeywords.value.split('\n').map(k => k.trim()).filter(Boolean),
                        rankData: []
                    };
                    projects.push(newProject);
                    currentProjectId = newProject.id;
                    localStorage.setItem('currentProjectId', currentProjectId);
                }
                saveProjects(projects);
                renderProjectSelector();
                displayCurrentProjectInfo();
                updateDashboard();
                closeModal();
            }

            // --- API 키 ---
            function saveApiKeys() {
                if(clientIdEl.value && clientSecretEl.value) {
                    localStorage.setItem('naverClientId', clientIdEl.value);
                    localStorage.setItem('naverClientSecret', clientSecretEl.value);
                    alert('API 키가 안전하게 저장되었습니다!');
                } else {
                    alert('Client ID와 Client Secret을 모두 입력해주세요.');
                }
            }

            function loadApiKeys() {
                clientIdEl.value = localStorage.getItem('naverClientId') || '';
                clientSecretEl.value = localStorage.getItem('naverClientSecret') || '';
            }

            // --- 핵심 순위 추적 로직 ---
            async function handleRankCheck() {
                if (!currentProjectId) return alert('먼저 프로젝트를 선택하거나 생성해주세요.');
                
                const project = projects.find(p => p.id === currentProjectId);
                if (!project || project.keywords.length === 0) return alert('추적할 키워드를 입력해주세요.');

                const userClientId = localStorage.getItem('naverClientId');
                const userClientSecret = localStorage.getItem('naverClientSecret');
                if (!userClientId || !userClientSecret) return alert('API 키를 먼저 설정하고 저장해주세요.');

                loader.style.display = 'flex';
                resultContent.innerHTML = '<ul></ul>';
                
                for (const keyword of project.keywords) {
                    const rank = await fetchRankFromNetlify(keyword, project.productName, project.storeName, userClientId, userClientSecret);
                    const today = new Date().toISOString().split('T')[0];
                    const rankText = rank > 0 ? `${rank}위` : '1000위 밖';
                    
                    const li = document.createElement('li');
                    li.textContent = `[${today}] '${keyword}': ${rankText}`;
                    resultContent.querySelector('ul').appendChild(li);

                    if (rank > 0) {
                        project.rankData.push({ date: today, keyword, rank });
                    }
                }
                saveProjects(projects);
                loader.style.display = 'none';
                updateDashboard();
            }
            
            async function fetchRankFromNetlify(keyword, productName, storeName, clientId, clientSecret) {
                try {
                    const params = new URLSearchParams({
                        keyword, product: productName, store: storeName, clientId, clientSecret
                    });
                    const response = await fetch(`/.netlify/functions/get-rank?${params.toString()}`);
                    if (!response.ok) throw new Error(`서버 에러: ${response.status}`);
                    const data = await response.json();
                    return data.rank;
                } catch (error) {
                    console.error("API Error:", error);
                    resultContent.querySelector('ul').innerHTML += `<li style="color: red;">🚨 '${keyword}' 조회 중 에러 발생!</li>`;
                    return -1;
                }
            }

            // --- 대시보드 및 차트 ---
            function updateDashboard() {
                 if (!currentProjectId) {
                     document.getElementById('dashboard-subtitle').textContent = '프로젝트를 선택하면 순위 변화 그래프가 표시됩니다.';
                     if (rankChart) rankChart.destroy();
                     return;
                 }
                const project = projects.find(p => p.id === currentProjectId);
                document.getElementById('dashboard-subtitle').textContent = `'${project.name}' 프로젝트의 순위 변화 그래프입니다.`;

                const data = project ? project.rankData : [];
                const chartData = processDataForChart(data);
                
                if (rankChart) rankChart.destroy();

                rankChart = new Chart(rankChartEl, {
                    type: 'line', data: chartData,
                    options: { scales: { y: { reverse: true, beginAtZero: false } } }
                });
            }
            
            function processDataForChart(data) {
                // ... [이전과 동일한 로직] ...
                if (!data || data.length === 0) return { labels: [], datasets: [] };
                const labels = [...new Set(data.map(item => item.date))].sort();
                const keywords = [...new Set(data.map(item => item.keyword))];
                const datasets = keywords.map(keyword => {
                    const keywordData = labels.map(label => {
                        const entry = data.find(d => d.date === label && d.keyword === keyword);
                        return entry ? entry.rank : null;
                    });
                    const color = `hsl(${ (keywords.indexOf(keyword) * 60) % 360 }, 70%, 50%)`;
                    return { label: keyword, data: keywordData, borderColor: color, backgroundColor: color, fill: false, tension: 0.1 };
                });
                return { labels, datasets };
            }

            // --- 이벤트 리스너 연결 ---
            saveApiKeyBtn.addEventListener('click', saveApiKeys);
            newProjectBtn.addEventListener('click', () => openModal('new'));
            editProjectBtn.addEventListener('click', () => openModal('edit'));
            deleteProjectBtn.addEventListener('click', handleDeleteProject);
            projectSelector.addEventListener('change', handleProjectSelection);
            saveChangesLink.addEventListener('click', (e) => {
                e.preventDefault();
                saveCurrentProjectInfo();
            });
            modalCancelBtn.addEventListener('click', closeModal);
            modalSaveBtn.addEventListener('click', handleSaveProject);
            rankCheckBtn.addEventListener('click', handleRankCheck);

            // --- 앱 시작 ---
            initializeApp();
        });
    </script>
</body>
</html>