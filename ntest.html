<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>네이버 순위 탐정 조종기 v1.5</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* [이전 CSS 코드는 여기에 그대로 유지됩니다...] */
        /* ----------------------------------------------------------------------------- */
        /* 🕵️‍♂️ 네이버 순위 탐정 조종기 v1.5 - style.css                               */
        /* ----------------------------------------------------------------------------- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        :root {
            --primary-color: #03C75A; /* 네이버 그린 */
            --background-color: #f4f6f8;
            --card-background: #ffffff;
            --text-color: #333;
            --subtext-color: #666;
            --border-color: #e0e0e0;
            --danger-color: #EF233C;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }

        /* --- 2단 레이아웃 --- */
        .main-layout { display: flex; max-width: 1200px; margin: 30px auto; gap: 30px; padding: 0 20px; }
        .control-panel { flex: 1; position: sticky; top: 30px; align-self: flex-start; }
        .content-area { flex: 2; min-width: 0; }
        
        h1, h2 { font-weight: 700; margin-bottom: 10px; }
        h1 { text-align: center; color: var(--primary-color); font-size: 2rem; margin-bottom: 30px; }
        
        .card { background-color: var(--card-background); border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .card h2 { font-size: 1.5rem; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 20px; }
        .card p { color: var(--subtext-color); margin-bottom: 20px; font-size: 0.9rem; }
        
        input[type="text"], input[type="password"], textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; margin-bottom: 15px; transition: border-color 0.3s, box-shadow 0.3s; }
        input[type="text"]:focus, input[type="password"]:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(3, 199, 90, 0.2); }
        textarea { resize: vertical; }
        
        button { display: block; width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 700; color: white; background-color: var(--primary-color); cursor: pointer; transition: background-color 0.3s, transform 0.2s; }
        button:hover { background-color: #02b350; transform: translateY(-2px); }
        
        .dashboard-controls { display: flex; gap: 15px; margin-top: 20px; }
        #clear-data-btn { background-color: var(--danger-color); }
        #clear-data-btn:hover { background-color: #d90429; }
        
        .loader-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); justify-content: center; align-items: center; flex-direction: column; z-index: 999; }
        .loader { border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        .loader-container p { margin-top: 20px; font-size: 1.2rem; font-weight: 500; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #results-container ul { list-style-position: inside; padding-left: 10px; }
        #results-container li { margin-bottom: 8px; }

        #debug-container { margin-top: 20px; background-color: #2c2c2c; color: #f1f1f1; border-radius: 8px; padding: 15px; }
        #debug-container h2 { color: var(--primary-color); border-bottom: 1px solid #555; padding-bottom: 10px;}
        #debug-log { font-family: 'Courier New', Courier, monospace; white-space: pre-wrap; word-break: break-all; max-height: 300px; overflow-y: auto; font-size: 0.85rem; }
        
        @media (max-width: 992px) {
            .main-layout { flex-direction: column; }
            .control-panel { position: static; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>🕵️‍♂️ 네이버 순위 탐정 조종기 v1.5</h1>
        <div class="main-layout">
            <aside class="control-panel">
                <div class="card">
                    <h2>🔑 API 키 설정</h2>
                    <p>사용자님의 네이버 API 키를 입력하세요. 입력된 정보는 이 브라우저에만 안전하게 저장됩니다.</p>
                    <input type="password" id="naver-client-id" placeholder="네이버 Client ID">
                    <input type="password" id="naver-client-secret" placeholder="네이버 Client Secret">
                    <button id="save-api-key-btn">API 키 저장</button>
                </div>
                
                <div class="card">
                    <h2>🏆 순위 추적 모드</h2>
                    <p>추적할 키워드를 한 줄에 하나씩 입력하세요.</p>
                    <textarea id="rank-keywords" rows="5" placeholder="예:\n강아지 간식\n고양이 장난감\n햄스터 쳇바퀴"></textarea>
                    <input type="text" id="product-name" placeholder="내 상품명 (일부만 포함돼도 OK)">
                    <input type="text" id="store-name" placeholder="내 스토어명 (선택 사항)">
                    <button id="rank-check-btn">내 순위 추적!</button>
                </div>
            </aside>

            <main class="content-area">
                <div class="card">
                    <h2>📈 순위 변화 대시보드</h2>
                    <p>저장된 순위 데이터를 기반으로 키워드별 순위 변화 추이를 확인합니다.</p>
                    <canvas id="rank-chart"></canvas>
                    <div class="dashboard-controls">
                        <button id="update-dashboard-btn">대시보드 새로고침</button>
                        <button id="clear-data-btn">기록 전체 삭제</button>
                    </div>
                </div>

                <div id="results-container" class="card">
                    <h2>📊 결과 보고서</h2>
                    <div id="result-content">
                        <p>이곳에 순위 확인 결과가 표시됩니다.</p>
                    </div>
                </div>
                 <div id="debug-container">
                    <h2>🐞 개발자 디버깅 로그</h2>
                    <pre id="debug-log"></pre>
                </div>
            </main>
        </div>
    </div>

    <div id="loader" class="loader-container">
        <div class="loader"></div>
        <p>탐정님이 열심히 수사 중입니다... 잠시만 기다려주세요!</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const rankKeywordsEl = document.getElementById('rank-keywords');
            const productNameEl = document.getElementById('product-name');
            const storeNameEl = document.getElementById('store-name');
            const rankCheckBtn = document.getElementById('rank-check-btn');
            const loader = document.getElementById('loader');
            const resultContent = document.getElementById('result-content');
            const rankChartEl = document.getElementById('rank-chart').getContext('2d');
            const updateDashboardBtn = document.getElementById('update-dashboard-btn');
            const clearDataBtn = document.getElementById('clear-data-btn');
            const saveApiKeyBtn = document.getElementById('save-api-key-btn');
            const clientIdEl = document.getElementById('naver-client-id');
            const clientSecretEl = document.getElementById('naver-client-secret');

            let rankChart;

            // --- API 키 관리 ---
            function saveApiKeys() {
                const clientId = clientIdEl.value;
                const clientSecret = clientSecretEl.value;
                if(clientId && clientSecret) {
                    localStorage.setItem('naverClientId', clientId);
                    localStorage.setItem('naverClientSecret', clientSecret);
                    logDebug('API 키가 브라우저에 저장되었습니다.');
                    alert('API 키가 안전하게 저장되었습니다!');
                } else {
                    alert('Client ID와 Client Secret을 모두 입력해주세요.');
                }
            }

            function loadApiKeys() {
                const savedId = localStorage.getItem('naverClientId');
                const savedSecret = localStorage.getItem('naverClientSecret');
                if (savedId && savedSecret) {
                    clientIdEl.value = savedId;
                    clientSecretEl.value = savedSecret;
                    logDebug('저장된 API 키를 불러왔습니다.');
                }
            }
            
            saveApiKeyBtn.addEventListener('click', saveApiKeys);

            // --- 순위 데이터 관리 ---
            const getRankData = () => JSON.parse(localStorage.getItem('rankData')) || [];
            const saveRankData = (data) => localStorage.setItem('rankData', JSON.stringify(data));

            // --- 메인 로직 ---
            async function handleRankCheck() {
                const keywords = rankKeywordsEl.value.split('\n').filter(k => k.trim() !== '');
                const productName = productNameEl.value.trim();

                if (keywords.length === 0 || !productName) {
                    alert('키워드와 상품명을 모두 입력해주세요.');
                    return;
                }
                
                const userClientId = localStorage.getItem('naverClientId');
                const userClientSecret = localStorage.getItem('naverClientSecret');

                if (!userClientId || !userClientSecret) {
                    alert('API 키를 먼저 설정하고 저장해주세요.');
                    return;
                }

                loader.style.display = 'flex';
                resultContent.innerHTML = '<ul></ul>';
                
                for (const keyword of keywords) {
                    const rank = await fetchRankFromNetlify(keyword, productName, storeNameEl.value.trim(), userClientId, userClientSecret);
                    const today = new Date().toISOString().split('T')[0];
                    const rankText = rank > 0 ? `${rank}위` : '순위권 밖';
                    
                    const li = document.createElement('li');
                    li.textContent = `[${today}] '${keyword}': ${rankText}`;
                    resultContent.querySelector('ul').appendChild(li);

                    if (rank > 0) {
                        const currentData = getRankData();
                        currentData.push({ date: today, keyword, rank });
                        saveRankData(currentData);
                    }
                }
                
                loader.style.display = 'none';
                updateDashboard();
            }

            rankCheckBtn.addEventListener('click', handleRankCheck);

            // --- 대시보드 및 차트 ---
            function updateDashboard() {
                const data = getRankData();
                logDebug(`${data.length}개의 순위 데이터를 기반으로 대시보드를 업데이트합니다.`);
                const chartData = processDataForChart(data);

                if (rankChart) {
                    rankChart.destroy();
                }

                rankChart = new Chart(rankChartEl, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                reverse: true,
                                beginAtZero: false
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y}위`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            updateDashboardBtn.addEventListener('click', updateDashboard);

            function processDataForChart(data) {
                if (!data || data.length === 0) return { labels: [], datasets: [] };

                const labels = [...new Set(data.map(item => item.date))].sort();
                const keywords = [...new Set(data.map(item => item.keyword))];
                const datasets = keywords.map(keyword => {
                    const keywordData = labels.map(label => {
                        const entry = data.find(d => d.date === label && d.keyword === keyword);
                        return entry ? entry.rank : null;
                    });
                    const color = `hsl(${Math.random() * 360}, 70%, 50%)`;
                    return {
                        label: keyword,
                        data: keywordData,
                        borderColor: color,
                        backgroundColor: color,
                        fill: false,
                        tension: 0.1
                    };
                });
                return { labels, datasets };
            }

            function handleClearData() {
                if (confirm('정말로 모든 순위 기록을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                    localStorage.removeItem('rankData');
                    logDebug('모든 순위 데이터가 삭제되었습니다.');
                    updateDashboard();
                }
            }
            clearDataBtn.addEventListener('click', handleClearData);
            
            // --- API 호출 ---
            async function fetchRankFromNetlify(keyword, productName, storeName, clientId, clientSecret) {
                logDebug(`(API 호출) Keyword: ${keyword}, Product: ${productName}`);
                try {
                    const params = new URLSearchParams({
                        keyword: keyword,
                        product: productName,
                        store: storeName,
                        clientId: clientId,
                        clientSecret: clientSecret
                    });
                    
                    const response = await fetch(`/.netlify/functions/get-rank?${params.toString()}`);
                    
                    if (!response.ok) {
                        throw new Error(`서버 에러 발생: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    return data.rank;

                } catch (error) {
                    logDebug(`API 호출 실패: ${error.message}`);
                    resultContent.querySelector('ul').innerHTML += `<li style="color: red;">🚨 '${keyword}' 순위 조회 중 서버 에러 발생!</li>`;
                    return -1;
                }
            }

            // --- 디버깅 툴 ---
            function logDebug(message) {
                const debugLog = document.getElementById('debug-log');
                const timestamp = new Date().toLocaleTimeString();
                debugLog.innerHTML += `[${timestamp}] ${message}\n`;
                console.log(`[DEBUG] ${message}`);
            }

            // --- 초기화 ---
            loadApiKeys();
            updateDashboard();
            logDebug("순위 탐정 조종기 v1.5가 초기화되었습니다.");
        });
    </script>
</body>
</html>